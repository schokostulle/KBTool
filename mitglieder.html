<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mitgliederverwaltung – Orden der Ersten Seefahrt</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="ocean-bg" aria-hidden="true"></div>
  <main class="dashboard-shell">
    <aside class="sidebar">
      <h2 class="logo">⚓ Crewmenü</h2>
      <nav>
        <ul>
          <li><a href="dashboard.html">🏠 Übersicht</a></li>
          <li><a href="mitglieder.html" class="active">👥 Mitglieder</a></li>
          <li><button id="logout-btn" class="btn small">🚪 Abmelden</button></li>
        </ul>
      </nav>
    </aside>

    <section class="main-content">
      <header>
        <h1>Mitgliederverwaltung</h1>
        <p class="subtitle">Alle registrierten Crewmitglieder im Überblick.</p>
      </header>

      <div id="member-list" class="member-list">
        <p>Lade Mitgliederliste …</p>
      </div>
    </section>
  </main>

  <script>
    const SUPABASE_URL = "https://YOUR-PROJECT-ref.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function checkAuth() {
      const { data } = await supabase.auth.getUser();
      if (!data.user) window.location.href = "index.html";
    }

    // Load users from auth.users — zeige nickname (raw_user_meta_data.nickname) wenn vorhanden
    async function loadMembers() {
      const list = document.getElementById("member-list");
      list.innerHTML = "<p>Lädt …</p>";

      try {
        // Beachte: Zugriff auf auth.users setzt entsprechende DB-Rechte voraus (wie in deiner Vorgabe).
        const { data, error } = await supabase
          .from("auth.users")
          .select("id, email, raw_user_meta_data, created_at")
          .order("created_at", { ascending: true });

        if (error) {
          list.innerHTML = `<p class='error'>Fehler beim Laden: ${error.message}</p>`;
          return;
        }
        if (!data || data.length === 0) {
          list.innerHTML = "<p>Keine Mitglieder gefunden.</p>";
          return;
        }

        const rows = data.map(u => {
          const meta = u.raw_user_meta_data || {};
          const nickname = meta.nickname || (u.email ? u.email.split("@")[0] : "–");
          const created = u.created_at ? new Date(u.created_at).toLocaleString("de-DE") : "-";
          return `
            <tr>
              <td>${escapeHtml(nickname)}</td>
              <td>${escapeHtml(u.email || "")}</td>
              <td>${escapeHtml(created)}</td>
              <td><code>${escapeHtml(u.id)}</code></td>
            </tr>
          `;
        }).join("");

        list.innerHTML = `
          <table class="crew-table">
            <thead><tr><th>Nickname</th><th>Interne E-Mail</th><th>Beigetreten</th><th>ID</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } catch (err) {
        list.innerHTML = `<p class='error'>Fehler: ${err.message}</p>`;
      }
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    document.getElementById("logout-btn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "index.html";
    });

    // Start
    checkAuth();
    loadMembers();
  </script>
</body>
</html>