<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bullfrog Tools ‚Äì Dashboard</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>

<body>
  <header style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#222;color:#fff;">
    <h2>Bullfrog Tools</h2>
    <button id="logoutBtn" title="Logout" style="background:none;border:none;cursor:pointer;">
      üèïÔ∏è
    </button>
  </header>

  <main style="display:flex;min-height:100vh;">
    <!-- ==================== SEITENMEN√ú ==================== -->
    <nav id="sideMenu" style="width:200px;background:#333;color:#fff;padding:10px;">
      <button class="navBtn" data-section="events">Ereignisse</button>
      <button class="navBtn" data-section="reports">Kriegsberichte</button>
      <button class="navBtn" data-section="fleet">Flottenst√§rke</button>
      <button class="navBtn" data-section="reserve">Inselreservierung</button>
      <button class="navBtn" data-section="attack">Angriff & Verteidigung</button>
      <button class="navBtn" data-section="map">Karte</button>
      <button class="navBtn" data-section="kbdata">KB-Datenbank</button>

      <div class="admin-only" style="margin-top:20px;border-top:1px solid #555;padding-top:10px;">
        <h4>Admin</h4>
        <button class="navBtn" data-section="members">Mitglieder</button>
        <button class="navBtn" data-section="diplomacy">Diplomatie</button>
        <button class="navBtn" data-section="csv">CSV-Tabelle</button>
      </div>
    </nav>

    <!-- ==================== INHALTSBEREICH ==================== -->
    <section id="content" style="flex:1;padding:20px;">
      <h3 id="welcomeText"></h3>

      <!-- Abschnitt: Ereignisse -->
      <section id="eventsSection" class="contentSection">
        <h2>Ereignisse & Informationen</h2>
        <p>Hier erscheinen wichtige Mitteilungen der Admins und laufende Angriffe.</p>
      </section>

      <!-- Abschnitt: Kriegsberichte -->
      <section id="reportsSection" class="contentSection" hidden>
        <h2>Kriegsberichte</h2>
        <p>Hier k√∂nnen Mitglieder ihre Kampfberichte eintragen.</p>
      </section>

      <!-- Abschnitt: Flottenst√§rke -->
      <section id="fleetSection" class="contentSection" hidden>
        <h2>Flottenst√§rke</h2>
        <p>√úbersicht √ºber bekannte Truppen- und Flottenst√§rken.</p>
      </section>

      <!-- Abschnitt: Inselreservierung -->
      <section id="reserveSection" class="contentSection" hidden>
        <h2>Inselreservierungen</h2>
        <p>Hier kannst du Inseln reservieren oder freigeben.</p>
      </section>

      <!-- Abschnitt: Angriff & Verteidigung -->
      <section id="attackSection" class="contentSection" hidden>
        <h2>Angriffs- & Verteidigungstool</h2>
        <p>Berechnungen zu Laufzeiten, Entfernungen und Startzeiten.</p>
      </section>

      <!-- Abschnitt: Karte -->
      <section id="mapSection" class="contentSection" hidden>
        <h2>Inselkarte</h2>
        <p>Visuelle √úbersicht aller bekannten Inseln und Spieler.</p>
      </section>

      <!-- Abschnitt: KB-Datenbank -->
      <section id="kbdataSection" class="contentSection" hidden>
        <h2>Kampfberichte-Datenbank</h2>
        <p>Gespeicherte Berichte zur Analyse gegnerischer St√§rke.</p>
      </section>

      <!-- Abschnitt: Mitgliederverwaltung (nur Admin) -->
      <section id="membersSection" class="contentSection admin-only" hidden>
        <h2>Mitgliederverwaltung</h2>
        <table id="membersTable" border="1" cellspacing="0" cellpadding="5">
          <thead>
            <tr>
              <th>Benutzername</th>
              <th>Rolle</th>
              <th>Status</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Abschnitt: Diplomatie -->
      <section id="diplomacySection" class="contentSection admin-only" hidden>
        <h2>Diplomatie</h2>
        <p>Verwaltung befreundeter und feindlicher Allianzen.</p>
      </section>

      <!-- Abschnitt: CSV -->
      <section id="csvSection" class="contentSection admin-only" hidden>
        <h2>CSV-Datenbasis</h2>
        <p>Hier kann die aktuelle CSV-Datei hochgeladen werden.</p>
      </section>
    </section>
  </main>

  <!-- ==================== SCRIPT ==================== -->
  <script type="module">
    import {
      getCurrentUser,
      logoutUser,
      listUsers,
      updateUserStatus,
      changeUserRole,
      deleteUser
    } from "./supabase.js";

    // Benutzer abrufen
    const user = getCurrentUser();
    if (!user.username) {
      window.location.href = "index.html";
    }

    // Willkommensnachricht
    document.querySelector("#welcomeText").textContent =
      `Willkommen, ${user.username} (${user.role})`;

    // Admin-Bereiche sichtbar / unsichtbar
    document.querySelectorAll(".admin-only").forEach(el => {
      el.style.display = user.role === "admin" ? "block" : "none";
    });

    // Navigation zwischen Abschnitten
    const sections = document.querySelectorAll(".contentSection");
    document.querySelectorAll(".navBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        sections.forEach(sec => (sec.hidden = true));
        const target = document.querySelector(`#${btn.dataset.section}Section`);
        if (target) target.hidden = false;

        if (btn.dataset.section === "members" && user.role === "admin") {
          loadMembers();
        }
      });
    });

    // Logout
    document.querySelector("#logoutBtn").addEventListener("click", async () => {
      await logoutUser();
      window.location.href = "index.html";
    });

    // Mitgliederverwaltung laden
    async function loadMembers() {
      const tbody = document.querySelector("#membersTable tbody");
      tbody.innerHTML = "<tr><td colspan='4'>Lade...</td></tr>";

      try {
        const users = await listUsers();
        tbody.innerHTML = "";

        users.forEach(u => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${u.username}</td>
            <td>${u.role}</td>
            <td>${u.status}</td>
            <td>
              <button data-action="activate" data-id="${u.id}" ${u.status === "active" ? "disabled" : ""}>Freigeben</button>
              <button data-action="block" data-id="${u.id}" ${u.status === "blocked" ? "disabled" : ""}>Blockieren</button>
              <button data-action="role" data-id="${u.id}">Rolle √§ndern</button>
              <button data-action="delete" data-id="${u.id}">L√∂schen</button>
            </td>`;
          tbody.appendChild(row);
        });

        tbody.querySelectorAll("button").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const action = btn.dataset.action;

            if (action === "activate") await updateUserStatus(id, "active");
            if (action === "block") await updateUserStatus(id, "blocked");
            if (action === "role") {
              const newRole = prompt("Neue Rolle (admin/member):", "member");
              if (newRole) await changeUserRole(id, newRole);
            }
            if (action === "delete") {
              if (confirm("Diesen Benutzer wirklich l√∂schen?")) await deleteUser(id);
            }
            await loadMembers();
          });
        });
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan='4'>Fehler: ${err.message}</td></tr>`;
      }
    }
  </script>
</body>
</html>