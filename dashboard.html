<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bullfrog Tools – Dashboard</title>
  <style>
    body { background:#121212; color:#eee; font-family:Arial; margin:0; display:flex; height:100vh; }
    nav { width:220px; background:#1e1e1e; padding:15px; display:flex; flex-direction:column; }
    nav h2 { color:#00aaff; margin-bottom:15px; }
    nav button { background:#2a2a2a; border:none; color:#eee; padding:10px; margin-bottom:8px; border-radius:5px; cursor:pointer; text-align:left; }
    nav button:hover { background:#007bff; }
    main { flex:1; padding:20px; overflow:auto; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { padding:8px; border-bottom:1px solid #333; }
    th { background:#222; }
    tr:nth-child(even){background:#181818;}
    .hidden{display:none;}
    .pending{background:#40311f;padding:10px;border-radius:5px;color:#ffc107;}
    button.action{border:none;border-radius:4px;padding:5px 10px;margin-right:5px;color:#fff;cursor:pointer;}
    .blue{background:#007bff;}
    .red{background:#b33;}
    .gray{background:#555;}
  </style>
</head>
<body>
  <nav>
    <h2>Bullfrog Tools</h2>
    <button data-sec="events">Ereignisse</button>
    <button data-sec="battle">Kampfberichte</button>
    <button data-sec="reserve">Inseln reservieren</button>
    <div id="adminMenu" class="hidden">
      <hr>
      <button data-sec="members">Mitgliederverwaltung</button>
    </div>
    <hr>
    <button id="logoutBtn">Abmelden</button>
  </nav>
  <main id="main">
    <h1>Willkommen bei Bullfrog Tools</h1>
    <div id="pendingMsg" class="pending hidden">
      Dein Account ist noch nicht freigeschaltet. Bitte warte auf Freigabe.
    </div>
  </main>

  <script type="module">
    import { supabase, getSession, logout } from "./supabase.js";

    const user = await getSession();
    if (!user) {
      alert("Bitte neu anmelden");
      window.location.href = "index.html";
    }

    const { data: rows } = await supabase.from("users").select("*").eq("id", user.id);
    const me = rows?.[0];
    const main = document.getElementById("main");
    const adminMenu = document.getElementById("adminMenu");
    const pendingMsg = document.getElementById("pendingMsg");

    if (me?.status === "pending") pendingMsg.classList.remove("hidden");
    if (me?.role === "admin") adminMenu.classList.remove("hidden");

    document.getElementById("logoutBtn").onclick = logout;

    // Navigation
    document.querySelectorAll("button[data-sec]").forEach((btn) => {
      btn.onclick = async () => {
        const sec = btn.getAttribute("data-sec");
        if (sec === "members") showMembers();
        else main.innerHTML = `<h2>${sec}</h2><p>Modul wird bald verfügbar sein.</p>`;
      };
    });

    // Mitgliederverwaltung
    async function showMembers() {
      const { data: members } = await supabase.from("users").select("*").order("created_at");
      let html = `<h2>Mitgliederverwaltung</h2><table><tr><th>Name</th><th>Rolle</th><th>Status</th><th>Aktionen</th></tr>`;
      for (const m of members) {
        html += `<tr style="background:${m.status === "active" ? "#1f4025" : "#40311f"}">
          <td>${m.name}</td><td>${m.role}</td><td>${m.status}</td>
          <td>
            <button class="action blue" data-act="activate" data-id="${m.id}">Freischalten</button>
            <button class="action red" data-act="block" data-id="${m.id}">Sperren</button>
            <button class="action gray" data-act="delete" data-id="${m.id}">Löschen</button>
          </td></tr>`;
      }
      html += "</table>";
      main.innerHTML = html;

      main.querySelectorAll("button[data-act]").forEach((b) => {
        b.onclick = async () => {
          const id = b.dataset.id, act = b.dataset.act;
          if (act === "activate") await supabase.from("users").update({ status: "active" }).eq("id", id);
          if (act === "block") await supabase.from("users").update({ status: "pending" }).eq("id", id);
          if (act === "delete") await supabase.from("users").delete().eq("id", id);
          showMembers();
        };
      });
    }
  </script>
</body>
</html>