<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bullfrog Tools â€“ Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Seiten-Navigation */
    nav {
      width: 230px;
      background: #1e1e1e;
      display: flex;
      flex-direction: column;
      padding: 15px;
      box-sizing: border-box;
      border-right: 1px solid #333;
    }

    nav h2 {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #00aaff;
    }

    nav button {
      background: #2a2a2a;
      border: none;
      color: #eee;
      padding: 10px;
      text-align: left;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
    }

    nav button:hover {
      background: #007bff;
    }

    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    hr {
      border: none;
      height: 1px;
      background: #333;
      margin: 12px 0;
    }

    .pending {
      background-color: #402e1e;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      color: #ffcc00;
    }

    .hidden {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border-bottom: 1px solid #333;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #222;
    }

    tr:nth-child(even) {
      background: #181818;
    }

    button.action {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
    }

    .blue { background-color: #007bff; }
    .red { background-color: #b33; }
    .gray { background-color: #666; }
  </style>
</head>
<body>
  <nav id="nav">
    <h2>Bullfrog Tools</h2>
    <button data-section="events">Ereignisse</button>
    <button data-section="battle">Kampfberichte</button>
    <button data-section="reserve">Inseln reservieren</button>
    <button data-section="map">Inselkarte</button>
    <div id="adminPanel" class="hidden">
      <hr />
      <button data-section="csv">CSV-Tabelle</button>
      <button data-section="members">Mitgliederverwaltung</button>
      <button data-section="diplomacy">Diplomatie</button>
    </div>
    <hr />
    <button id="btnLogout">Abmelden</button>
  </nav>

  <main id="main">
    <h1>Willkommen bei Bullfrog Tools</h1>
    <div id="pendingNotice" class="pending hidden">
      Dein Account ist noch nicht freigeschaltet. Bitte warte auf Freigabe durch einen Admin.
    </div>
  </main>

  <!-- Script -->
  <script type="module">
    import { supabase, getUserClaims, logout } from "./supabase.js";

    const nav = document.getElementById("nav");
    const adminPanel = document.getElementById("adminPanel");
    const pendingNotice = document.getElementById("pendingNotice");
    const main = document.getElementById("main");

    document.getElementById("btnLogout").addEventListener("click", logout);

    // Sitzung prÃ¼fen und Benutzerinformationen aus JWT laden
    const user = await getUserClaims();

    if (!user) {
      alert("Keine aktive Sitzung â€“ bitte neu anmelden.");
      window.location.href = "index.html";
    } else {
      main.innerHTML = `<h1>Willkommen, ${user.email.split("@")[0]}!</h1>`;
      if (user.status === "pending") {
        pendingNotice.classList.remove("hidden");
      }
      if (user.role === "admin") {
        adminPanel.classList.remove("hidden");
      }
    }

    // Navigation zwischen Modulen
    nav.querySelectorAll("button[data-section]").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const section = btn.getAttribute("data-section");
        if (section === "members") {
          await showMembers();
        } else {
          main.innerHTML = `<h2>${section}</h2><p>Hier wird spÃ¤ter das Modul "${section}" angezeigt.</p>`;
        }
      });
    });

   // ==========================================
// ðŸ‘¥ Mitgliederverwaltung (nur Admin)
// ==========================================
async function showMembers() {
  main.innerHTML = "<h2>Mitgliederverwaltung</h2><p>Lade Mitglieder...</p>";

  const { data: members, error } = await supabase
    .from("users")
    .select("id, name, role, status, created_at")
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    main.innerHTML = "<p>Fehler beim Laden der Mitglieder.</p>";
    return;
  }

  let html = `
    <h2>Mitgliederverwaltung</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Rolle</th>
          <th>Status</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
  `;

  for (const m of members) {
    html += `
      <tr style="background:${
        m.status === "active" ? "#1e4021" : "#402e1e"
      };">
        <td>${m.name}</td>
        <td>${m.role}</td>
        <td>${m.status}</td>
        <td>
          <button class="action blue" data-action="activate" data-id="${m.id}">Freischalten</button>
          <button class="action red" data-action="block" data-id="${m.id}">Sperren</button>
          <button class="action gray" data-action="delete" data-id="${m.id}">LÃ¶schen</button>
        </td>
      </tr>
    `;
  }

  html += "</tbody></table>";
  main.innerHTML = html;

  // Aktionen
  main.querySelectorAll("button[data-action]").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (action === "activate") {
        await updateStatus(id, "active");
      } else if (action === "block") {
        await updateStatus(id, "pending");
      } else if (action === "delete") {
        await deleteUser(id);
      }
      await showMembers(); // neu laden
    });
  });
}

async function updateStatus(id, status) {
  const { error } = await supabase.from("users").update({ status }).eq("id", id);
  if (error) alert("Fehler: " + error.message);
}

async function deleteUser(id) {
  if (!confirm("Benutzer wirklich lÃ¶schen?")) return;
  const { error } = await supabase.from("users").delete().eq("id", id);
  if (error) alert("Fehler: " + error.message);
}

  </script>
</body>
</html>