<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Bullfrog Tools – Dashboard</title>
</head>

<body>
  <button id="logoutBtn">Logout</button>

  <nav id="sidebar">
    <button class="nav-btn active" data-section="events">Ereignisse</button>
    <button class="nav-btn" data-section="reports">Kriegsberichte</button>
    <button class="nav-btn" data-section="fleet">Flottenstärke</button>
    <button class="nav-btn" data-section="reservations">Inselreservierung</button>
    <button class="nav-btn" data-section="battle">Angriff & Verteidigung</button>
    <button class="nav-btn" data-section="map">Karte</button>
    <button class="nav-btn" data-section="database">KB-Datenbank</button>
    <hr>
    <button class="nav-btn admin-only" data-section="members">Mitgliederverwaltung</button>
    <button class="nav-btn admin-only" data-section="diplomacy">Diplomatie</button>
    <button class="nav-btn admin-only" data-section="csv">CSV-Datenbasis</button>
  </nav>

  <div id="content">
    <section id="eventsSection"><h2>Ereignisse</h2></section>
    <section id="reportsSection" hidden><h2>Kriegsberichte</h2></section>
    <section id="fleetSection" hidden><h2>Flottenstärke</h2></section>
    <section id="reservationsSection" hidden><h2>Inselreservierung</h2></section>
    <section id="battleSection" hidden><h2>Angriff & Verteidigung</h2></section>
    <section id="mapSection" hidden><h2>Karte</h2></section>
    <section id="databaseSection" hidden><h2>KB-Datenbank</h2></section>
    <section id="membersSection" hidden>
  <h2>Mitgliederverwaltung</h2>
  <table id="membersTable">
    <thead>
      <tr>
        <th>Benutzername</th>
        <th>Rolle</th>
        <th>Status</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>
    <section id="diplomacySection" hidden><h2>Diplomatie</h2></section>
    <section id="csvSection" hidden><h2>CSV-Datenbasis</h2></section>
  </div>

  <script type="module">
    import { logoutUser } from "./supabase.js";

    document.getElementById("logoutBtn").onclick = () => logoutUser();

    const sections = {
      events: "eventsSection",
      reports: "reportsSection",
      fleet: "fleetSection",
      reservations: "reservationsSection",
      battle: "battleSection",
      map: "mapSection",
      database: "databaseSection",
      members: "membersSection",
      diplomacy: "diplomacySection",
      csv: "csvSection"
    };

import { listUsers, updateUserStatus, changeUserRole, deleteUser } from "./supabase.js";

async function loadMembers() {
  const tableBody = document.querySelector("#membersTable tbody");
  tableBody.innerHTML = "";
  const users = await listUsers();

  users.forEach(u => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td>${u.status}</td>
      <td>
        <button data-action="activate" data-id="${u.id}" ${u.status === "active" ? "disabled" : ""}>Freigeben</button>
        <button data-action="block" data-id="${u.id}" ${u.status === "blocked" ? "disabled" : ""}>Blockieren</button>
        <button data-action="toggleRole" data-id="${u.id}">Rolle ändern</button>
        <button data-action="delete" data-id="${u.id}">Löschen</button>
      </td>`;
    tableBody.appendChild(row);
  });

  // Event-Handler für Buttons
  tableBody.querySelectorAll("button").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if (action === "activate") {
        await updateUserStatus(id, "active");
      } else if (action === "block") {
        await updateUserStatus(id, "blocked");
      } else if (action === "toggleRole") {
        const newRole = prompt("Neue Rolle (admin/member):", "member");
        if (newRole) await changeUserRole(id, newRole);
      } else if (action === "delete") {
        if (confirm("Diesen Benutzer wirklich löschen?")) await deleteUser(id);
      }
      await loadMembers();
    };
  });
}

// Wenn auf Menüpunkt "Mitgliederverwaltung" geklickt wird → Tabelle laden
document.querySelector('[data-section="members"]').addEventListener("click", loadMembers);

    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        for (const key in sections)
          document.getElementById(sections[key]).hidden = true;
        const sec = sections[btn.dataset.section];
        if (sec) document.getElementById(sec).hidden = false;
      });
    });

    const role = localStorage.getItem("role");
    if (role !== "admin")
      document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
  </script>
</body>
</html>