<!-- ========================================================= -->
<!-- BLOCK 8: tools/mitglieder.html – Mitgliederverwaltung (Admin) -->
<!-- ========================================================= -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mitgliederverwaltung – Admin</title>
  <link rel="stylesheet" href="../CSS/style.css" />
</head>

<body>
  <!-- ========== Kopfbereich ========== -->
  <header>
    <h1>👑 Mitgliederverwaltung</h1>
    <button id="logout-button">Logout</button>
  </header>

  <!-- ========== Hauptbereich ========== -->
  <main>
    <section>
      <h2>Übersicht der Mitglieder</h2>
      <p>Hier kannst du Rollen ändern, Mitglieder sperren oder löschen.</p>

      <!-- Feedback -->
      <div id="info-message"></div>

      <!-- Tabelle -->
      <table id="member-table" border="1" cellpadding="6" cellspacing="0">
        <thead>
          <tr>
            <th>Benutzername</th>
            <th>E-Mail</th>
            <th>Rolle</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="member-body">
          <tr><td colspan="5">⏳ Lade Mitglieder…</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- ========== Skriptintegration ========== -->
  <script type="module">
    // =========================================================
    // BLOCK: Supabase-Client laden
    // =========================================================
    import { supabase } from '../JS/supabase.js';

    // =========================================================
    // BLOCK: Logout-Funktion
    // =========================================================
    document.getElementById('logout-button').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '../index.html';
    });

    // =========================================================
    // BLOCK: Zugriffskontrolle – nur Admins erlaubt
    // =========================================================
    async function checkAccess() {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = '../index.html';
        return;
      }

      const userId = data.session.user.id;
      const { data: profile, error } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', userId)
        .single();

      if (error || !profile || profile.role !== 'admin') {
        alert('🚫 Kein Zugriff – nur für Admins!');
        window.location.href = '../dashboard.html';
        return;
      }

      // Wenn Admin → Mitglieder laden
      loadMembers();
    }

    // =========================================================
    // BLOCK: Mitgliederliste laden
    // =========================================================
    async function loadMembers() {
      const tableBody = document.getElementById('member-body');
      tableBody.innerHTML = '<tr><td colspan="5">⏳ Lade Daten…</td></tr>';

      const { data: members, error } = await supabase
        .from('profiles')
        .select('id, username, role, banned, deleted');

      if (error) {
        tableBody.innerHTML = `<tr><td colspan="5">❌ Fehler: ${error.message}</td></tr>`;
        return;
      }

      if (!members.length) {
        tableBody.innerHTML = '<tr><td colspan="5">Keine Mitglieder gefunden.</td></tr>';
        return;
      }

      // Tabelle aufbauen
      tableBody.innerHTML = '';
      for (const m of members) {
        const status = m.deleted ? '🗑️ Gelöscht' : (m.banned ? '🚫 Gesperrt' : '✅ Aktiv');
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${m.username || '–'}</td>
          <td>${m.id}</td>
          <td>${m.role}</td>
          <td>${status}</td>
          <td>
            <button onclick="changeRole('${m.id}')">Rolle</button>
            <button onclick="toggleBan('${m.id}', ${m.banned})">${m.banned ? 'Entsperren' : 'Sperren'}</button>
            <button onclick="deleteUser('${m.id}')">Löschen</button>
          </td>
        `;
        tableBody.appendChild(row);
      }
    }

    // =========================================================
    // BLOCK: RPC Aufrufe (Rollenänderung, Sperren, Löschen)
    // =========================================================

    // Diese Funktionen rufen vorbereitete SQL-RPCs auf,
    // die du später im Supabase-SQL-Editor erstellst.

    window.changeRole = async function (userId) {
      const newRole = prompt('Neue Rolle eingeben (admin, member, anwärter):');
      if (!newRole) return;

      const { error } = await supabase.rpc('set_user_role', { uid: userId, new_role: newRole });
      if (error) {
        alert('❌ Fehler: ' + error.message);
      } else {
        alert('✅ Rolle aktualisiert.');
        loadMembers();
      }
    };

    window.toggleBan = async function (userId, isBanned) {
      const rpc = isBanned ? 'unblock_user' : 'block_user';
      const { error } = await supabase.rpc(rpc, { uid: userId });
      if (error) {
        alert('❌ Fehler: ' + error.message);
      } else {
        alert(isBanned ? '✅ Nutzer entsperrt.' : '🚫 Nutzer gesperrt.');
        loadMembers();
      }
    };

    window.deleteUser = async function (userId) {
      const confirmDelete = confirm('⚠️ Mitglied wirklich löschen?');
      if (!confirmDelete) return;

      const { error } = await supabase
        .from('profiles')
        .update({ deleted: true })
        .eq('id', userId);

      if (error) {
        alert('❌ Fehler: ' + error.message);
      } else {
        alert('🗑️ Mitglied markiert als gelöscht.');
        loadMembers();
      }
    };

    // =========================================================
    // BLOCK: Initialer Aufruf
    // =========================================================
    checkAccess();
  </script>
</body>
</html>