<!-- ========================================================= -->
<!-- BLOCK 8: tools/mitglieder.html â€“ Mitgliederverwaltung (Admin) -->
<!-- ========================================================= -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mitgliederverwaltung â€“ Admin</title>
  <link rel="stylesheet" href="../CSS/style.css" />
</head>

<body>
  <!-- ========== Kopfbereich ========== -->
  <header>
    <h1>ğŸ‘‘ Mitgliederverwaltung</h1>
    <button id="logout-button">Logout</button>
  </header>

  <!-- ========== Hauptbereich ========== -->
  <main>
    <section>
      <h2>Ãœbersicht der Mitglieder</h2>
      <p>Hier kannst du Rollen Ã¤ndern, Mitglieder sperren oder lÃ¶schen.</p>

      <!-- Feedback -->
      <div id="info-message"></div>

      <!-- Tabelle -->
      <table id="member-table" border="1" cellpadding="6" cellspacing="0">
        <thead>
          <tr>
            <th>Benutzername</th>
            <th>E-Mail</th>
            <th>Rolle</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="member-body">
          <tr><td colspan="5">â³ Lade Mitgliederâ€¦</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- ========== Skriptintegration ========== -->
  <script type="module">
    // =========================================================
    // BLOCK: Supabase-Client laden
    // =========================================================
    import { supabase } from '../JS/supabase.js';

    // =========================================================
    // BLOCK: Logout-Funktion
    // =========================================================
    document.getElementById('logout-button').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '../index.html';
    });

    // =========================================================
    // BLOCK: Zugriffskontrolle â€“ nur Admins erlaubt
    // =========================================================
    async function checkAccess() {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = '../index.html';
        return;
      }

      const userId = data.session.user.id;
      const { data: profile, error } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', userId)
        .single();

      if (error || !profile || profile.role !== 'admin') {
        alert('ğŸš« Kein Zugriff â€“ nur fÃ¼r Admins!');
        window.location.href = '../dashboard.html';
        return;
      }

      // Wenn Admin â†’ Mitglieder laden
      loadMembers();
    }

    // =========================================================
    // BLOCK: Mitgliederliste laden
    // =========================================================
    async function loadMembers() {
      const tableBody = document.getElementById('member-body');
      tableBody.innerHTML = '<tr><td colspan="5">â³ Lade Datenâ€¦</td></tr>';

      const { data: members, error } = await supabase
        .from('profiles')
        .select('id, username, role, banned, deleted');

      if (error) {
        tableBody.innerHTML = `<tr><td colspan="5">âŒ Fehler: ${error.message}</td></tr>`;
        return;
      }

      if (!members.length) {
        tableBody.innerHTML = '<tr><td colspan="5">Keine Mitglieder gefunden.</td></tr>';
        return;
      }

      // Tabelle aufbauen
      tableBody.innerHTML = '';
      for (const m of members) {
        const status = m.deleted ? 'ğŸ—‘ï¸ GelÃ¶scht' : (m.banned ? 'ğŸš« Gesperrt' : 'âœ… Aktiv');
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${m.username || 'â€“'}</td>
          <td>${m.id}</td>
          <td>${m.role}</td>
          <td>${status}</td>
          <td>
            <button onclick="changeRole('${m.id}')">Rolle</button>
            <button onclick="toggleBan('${m.id}', ${m.banned})">${m.banned ? 'Entsperren' : 'Sperren'}</button>
            <button onclick="deleteUser('${m.id}')">LÃ¶schen</button>
          </td>
        `;
        tableBody.appendChild(row);
      }
    }

    // =========================================================
    // BLOCK: RPC Aufrufe (RollenaÌˆnderung, Sperren, LÃ¶schen)
    // =========================================================

    // Diese Funktionen rufen vorbereitete SQL-RPCs auf,
    // die du spÃ¤ter im Supabase-SQL-Editor erstellst.

    window.changeRole = async function (userId) {
      const newRole = prompt('Neue Rolle eingeben (admin, member, anwÃ¤rter):');
      if (!newRole) return;

      const { error } = await supabase.rpc('set_user_role', { uid: userId, new_role: newRole });
      if (error) {
        alert('âŒ Fehler: ' + error.message);
      } else {
        alert('âœ… Rolle aktualisiert.');
        loadMembers();
      }
    };

    window.toggleBan = async function (userId, isBanned) {
      const rpc = isBanned ? 'unblock_user' : 'block_user';
      const { error } = await supabase.rpc(rpc, { uid: userId });
      if (error) {
        alert('âŒ Fehler: ' + error.message);
      } else {
        alert(isBanned ? 'âœ… Nutzer entsperrt.' : 'ğŸš« Nutzer gesperrt.');
        loadMembers();
      }
    };

    window.deleteUser = async function (userId) {
      const confirmDelete = confirm('âš ï¸ Mitglied wirklich lÃ¶schen?');
      if (!confirmDelete) return;

      const { error } = await supabase
        .from('profiles')
        .update({ deleted: true })
        .eq('id', userId);

      if (error) {
        alert('âŒ Fehler: ' + error.message);
      } else {
        alert('ğŸ—‘ï¸ Mitglied markiert als gelÃ¶scht.');
        loadMembers();
      }
    };

    // =========================================================
    // BLOCK: Initialer Aufruf
    // =========================================================
    checkAccess();
  </script>
</body>
</html>