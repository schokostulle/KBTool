<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Allianz Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<!-- ========== DESIGN ========== -->
<style>
:root {
  --bg: #f9fafb;
  --card: #ffffff;
  --text: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --danger: #ef4444;
  --success: #16a34a;
  --warn: #facc15;
}
[data-theme="dark"] {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #e2e8f0;
  --text-muted: #94a3b8;
  --border: #334155;
  --accent: #3b82f6;
  --accent-hover: #60a5fa;
  --danger: #f87171;
  --success: #22c55e;
  --warn: #fcd34d;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: "Inter", sans-serif;
  margin: 0;
  padding: 2rem;
  transition: background 0.3s, color 0.3s;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  padding: 1rem;
  margin-bottom: 1.5rem;
  transition: background 0.3s, border-color 0.3s;
}
input, button {
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #fff;
  color: var(--text);
  padding: 8px 12px;
  transition: all 0.2s;
}
[data-theme="dark"] input {
  background: #1e293b;
  color: var(--text);
  border-color: var(--border);
}
button {
  background: var(--accent);
  color: #fff;
  cursor: pointer;
  border: none;
}
button:hover { background: var(--accent-hover); }
button.ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}
button.ghost:hover {
  background: var(--accent);
  color: #fff;
}
.nav { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
.hidden { display: none; }
h1 { margin-top: 0; }
table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 10px;
  overflow: hidden;
}
th, td {
  border-bottom: 1px solid var(--border);
  padding: 10px 12px;
  text-align: left;
  font-size: 14px;
}
th {
  background: var(--card);
  color: var(--text-muted);
  cursor: pointer;
}
tr.requested { background: rgba(250,204,21,0.15); }
tr.approved { background: rgba(22,163,74,0.12); }
tr.denied { background: rgba(239,68,68,0.12); }

.note { font-size: 13px; color: var(--text-muted); }

/* Dropdown-Filter minimalistisch */
.col-filter {
  position: absolute;
  min-width: 220px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  padding: 8px;
  z-index: 10;
}
.options-box {
  max-height: 220px;
  overflow: auto;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 4px;
}
.option-row { display: flex; align-items: center; gap: 6px; font-size: 13px; padding: 3px 0; }
.filter-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 8px; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
.dot-free { background: #9aa3c7; }
.dot-requested { background: var(--warn); }
.dot-approved { background: var(--success); }
.dot-denied { background: var(--danger); }
</style>
</head>
<body>

<h1>🏝 Allianz Dashboard</h1>
<button class="ghost" id="themeToggle" style="float:right" onclick="toggleTheme()">🌙</button>

<!-- LOGIN -->
<div id="loginView" class="card">
  <h2>Login / Registrierung</h2>
  <input id="username" placeholder="Ingame-Name" />
  <input id="password" type="password" placeholder="Passwort" />
  <div style="margin-top:8px;">
    <button onclick="login()">Anmelden</button>
    <button class="ghost" onclick="register()">Registrieren</button>
  </div>
</div>

<!-- APP -->
<div id="appView" class="hidden">
  <div class="card">
    Angemeldet als <b id="userDisplay">–</b> (<span id="roleDisplay">–</span>)
    <div class="nav">
      <button onclick="showPage('tableView')">📊 Insel-Tabelle</button>
      <button onclick="showPage('mapView')">🗺 Karte</button>
      <button id="adminTab" class="hidden" onclick="showPage('adminView')">⚙️ Rollenverwaltung</button>
      <button id="csvTab" class="hidden" onclick="showPage('csvView')">📤 CSV Upload</button>
      <span style="flex:1"></span>
      <button class="ghost" onclick="logout()">🚪 Abmelden</button>
    </div>
  </div>

  <div id="tableView" class="card"><h3>📊 Inseln</h3><div id="tableContainer"></div></div>
  <div id="mapView" class="card hidden"><h3>🗺 Inselkarte</h3><canvas id="mapCanvas" width="900" height="560"></canvas></div>
  <div id="adminView" class="card hidden"><h3>⚙️ Rollenverwaltung</h3><div id="userTable"></div></div>
  <div id="csvView" class="card hidden">
    <h3>📤 CSV hochladen (Admin)</h3>
    <input type="file" id="csvInput" accept=".csv" />
    <button onclick="uploadCSV()">Hochladen</button>
    <div id="csvStatus" class="note"></div>
  </div>
</div>

<script>
/* ===== Firebase Setup ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const usersRef = db.collection("users");
const islandsRef = db.collection("islands");
const reservationsRef = db.collection("reservations");

/* ===== App State ===== */
let currentUser = null;
let currentRole = "member";
let csvData = [];
let reservations = {};

/* ===== Theme Toggle ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  const pref = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', pref);
  document.getElementById('themeToggle').textContent = pref==='dark'?'☀️':'🌙';
});
function toggleTheme(){
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  const next = isDark ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  document.getElementById('themeToggle').textContent = next==='dark'?'☀️':'🌙';
}

/* ===== Auth ===== */
function fakeEmail(n){ return n.toLowerCase().replace(/\s+/g,"_")+"@alliancesystem.fake"; }
async function login(){
  const n=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if(!n||!p)return alert("Bitte Ingame-Name & Passwort angeben!");
  try{await auth.signInWithEmailAndPassword(fakeEmail(n),p);}catch(e){alert(e.message);}
}
async function register(){
  const n=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if(!n||!p)return alert("Bitte Ingame-Name & Passwort angeben!");
  const adminExists=!(await usersRef.where("role","==","admin").get()).empty;
  try{
    await auth.createUserWithEmailAndPassword(fakeEmail(n),p);
    await usersRef.doc(n).set({ingameName:n,role:adminExists?"member":"admin"});
    alert(adminExists?"Registriert als Mitglied.":"Du bist der erste Admin!");
  }catch(e){alert(e.message);}
}
async function logout(){await auth.signOut();location.reload();}

auth.onAuthStateChanged(async u=>{
  if(!u)return;
  const name=u.email.split("@")[0].replace(/_/g," ");
  let role="member";
  const doc=await usersRef.doc(name).get();
  if(doc.exists&&doc.data().role)role=doc.data().role;else await usersRef.doc(name).set({ingameName:name,role},{merge:true});
  currentUser={...u,ingameName:name};currentRole=role;
  document.getElementById("loginView").classList.add("hidden");
  document.getElementById("appView").classList.remove("hidden");
  document.getElementById("userDisplay").textContent=name;
  document.getElementById("roleDisplay").textContent=role;
  if(role==="admin"){document.getElementById("adminTab").classList.remove("hidden");document.getElementById("csvTab").classList.remove("hidden");listenUsers();}
  loadCSV();listenReservations();
});

/* ===== CSV ===== */
async function uploadCSV(){
  if(currentRole!=="admin")return alert("Nur Admin darf CSV hochladen!");
  const f=document.getElementById("csvInput").files[0];
  if(!f)return alert("Keine CSV gewählt!");
  document.getElementById("csvStatus").textContent="Wird verarbeitet...";
  const t=await f.text();
  const rows=t.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(r=>r.split(";").map(v=>v.replace(/^"|"$/g,"").trim()));
  const mapped=rows.map(c=>({Ozean:c[0],Inselgruppe:c[1],Insel:c[2],Inselname:c[3],SpielerID:c[4],Spielername:c[5],AllianzID:c[6],AllianzKuerzel:c[7],Allianzname:c[8],Punkte:c[9]}));
  const old=await islandsRef.get();const b=db.batch();old.forEach(d=>b.delete(d.ref));await b.commit();
  const b2=db.batch();mapped.forEach((r,i)=>b2.set(islandsRef.doc(`${r.Ozean}-${r.Inselgruppe}-${r.Insel}-${i}`),r));await b2.commit();
  document.getElementById("csvStatus").textContent="CSV hochgeladen!";loadCSV();
}
async function loadCSV(){const s=await islandsRef.get();csvData=s.docs.map(d=>d.data());renderTable();}

/* ===== Reservierungen ===== */
function listenReservations(){
  reservationsRef.onSnapshot(s=>{reservations={};s.forEach(d=>reservations[d.id]=d.data());renderTable();if(!document.getElementById("mapView").classList.contains("hidden"))drawMap();});
}
async function reserve(k){await reservationsRef.doc(k).set({user:currentUser.ingameName,status:"requested"});}
async function approve(k){if(currentRole!=="admin")return;await reservationsRef.doc(k).update({status:"approved"});}
async function deny(k){if(currentRole!=="admin")return;await reservationsRef.doc(k).update({status:"denied"});}

/* ===== Tabelle ===== */
function renderTable(){
  const div=document.getElementById("tableContainer");
  if(!csvData.length){div.innerHTML="<p>Keine Daten.</p>";return;}
  let html="<table><thead><tr><th>Oz</th><th>IG</th><th>I</th><th>Spieler</th><th>Allianz</th><th>Punkte</th><th>Reserviert von</th><th>Aktion</th></tr></thead><tbody>";
  csvData.forEach(r=>{
    const key=`${r.Ozean}-${r.Inselgruppe}-${r.Insel}`;
    const res=reservations[key];
    const cls=res?.status||"";
    html+=`<tr class="${cls}"><td>${r.Ozean}</td><td>${r.Inselgruppe}</td><td>${r.Insel}</td>
    <td>${r.Spielername||"-"}</td><td>${r.Allianzname||"-"}</td><td>${r.Punkte||"-"}</td>
    <td>${res?.user||"-"}</td><td>${actionCell(key,res)}</td></tr>`;
  });
  html+="</tbody></table>";
  div.innerHTML=html;
}
function actionCell(k,res){
  if(!currentUser)return"<button disabled>Login nötig</button>";
  if(!res||res.status==="denied")return`<button onclick="reserve('${k}')">Reservieren</button>`;
  if(res.status==="requested"){
    if(res.user===currentUser.ingameName)return`<button disabled>Reserviert</button>`;
    if(currentRole==="admin")return`<button onclick="approve('${k}')">✔️</button><button class="ghost" onclick="deny('${k}')">✖️</button>`;
    return`<button disabled>${res.user}</button>`;
  }
  if(res.status==="approved"){
    if(res.user===currentUser.ingameName)return`<button disabled>✅</button>`;
    return`<button disabled>${res.user}</button>`;
  }
  return"-";
}

/* ===== Users ===== */
function listenUsers(){
  usersRef.onSnapshot(s=>{
    let h="<table><tr><th>Name</th><th>Rolle</th><th>Aktion</th></tr>";
    s.forEach(d=>{
      const u=d.data();
      h+=`<tr><td>${u.ingameName}</td><td>${u.role}</td><td>${roleBtns(u)}</td></tr>`;
    });
    h+="</table>";document.getElementById("userTable").innerHTML=h;
  });
}
function roleBtns(u){
  if(u.ingameName===currentUser.ingameName)return"<button disabled>👑</button>";
  if(u.role==="admin")return`<button class="ghost" onclick="setRole('${u.ingameName}','member')">⬇️ Mitglied</button>`;
  return`<button onclick="setRole('${u.ingameName}','admin')">⬆️ Admin</button>`;
}
async function setRole(n,r){await usersRef.doc(n).update({role:r});}

/* ===== Map ===== */
function drawMap(){
  const c=document.getElementById("mapCanvas");const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  csvData.forEach(r=>{
    const key=`${r.Ozean}-${r.Inselgruppe}-${r.Insel}`;const res=reservations[key];
    const x=(parseInt(r.Inselgruppe)||0)*6%(c.width-30)+20;
    const y=(parseInt(r.Ozean)||0)*90%(c.height-30)+20;
    let col="#9aa3c7";
    if(res?.status==="requested")col="#facc15";
    else if(res?.status==="approved")col="#22c55e";
    else if(res?.status==="denied")col="#ef4444";
    ctx.beginPath();ctx.arc(x,y,6,0,Math.PI*2);
    ctx.fillStyle=col;ctx.fill();ctx.strokeStyle="#2b3b6d";ctx.lineWidth=1;ctx.stroke();
  });
}
function showPage(id){["tableView","mapView","adminView","csvView"].forEach(v=>document.getElementById(v).classList.add("hidden"));document.getElementById(id).classList.remove("hidden");if(id==="mapView")drawMap();}
</script>
</body>
</html>