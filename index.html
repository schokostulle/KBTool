<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kampfbericht-Tool — CSV-Viewer (Grundgerüst)</title>

<!-- PapaParse für CSV -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
  body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:18px;background:#fafafa;color:#111}
  h1,h2{margin:8px 0}
  section{background:#fff;border-radius:8px;padding:12px;margin:12px 0;box-shadow:0 1px 6px rgba(0,0,0,0.06)}
  input,textarea,select,button{font:inherit;padding:8px;border:1px solid #ddd;border-radius:6px;margin:6px 0;width:100%;box-sizing:border-box}
  button.small{width:auto;padding:6px 10px}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid #ccc;padding:6px;text-align:left;font-size:0.95rem}
  th{background:#f2f2f2}
  .muted{color:#666;font-size:0.9rem}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .note{font-size:0.9rem;color:#444}
  .warn{color:crimson}
</style>
</head>
<body>

<h1>⚔️ Kampfbericht-Tool — CSV-Viewer (Grundgerüst)</h1>

<section id="csvSection">
  <h2>1) CSV hochladen (Host)</h2>
  <p class="muted">Wähle die Host-CSV-Datei aus. Die CSV wird lokal im Browser gespeichert (localStorage) – später ersetzen wir das durch Firestore für zentrale Speicherung.</p>
  <input type="file" id="csvFile" accept=".csv" />
  <div class="actions">
    <button id="btnProcessCsv" class="small">CSV verarbeiten & speichern</button>
    <button id="btnClearCsv" class="small" style="background:#ffdede">CSV löschen</button>
    <button id="btnClearAll" class="small" style="background:#ffdede">Alles (Reports + CSV) löschen</button>
  </div>
  <p id="csvStatus" class="note"></p>
</section>

<section id="tableSection">
  <h2>2) Tabellenansicht nach Koordinate & Datum (neueste zuerst)</h2>
  <p class="muted">Kopf: Koordinate, Datum des letzten Eintrags (oder 0), gefolgt von standardisierten Gebäude- und Einheiten-Spalten.</p>
  <div id="tableContainer"></div>
</section>

<script>
/* ============================
   Grundstruktur + CSV → Tabelle
   - Speichert CSV lokal (localStorage)
   - Ermittelt für jede Zeile eine "Koordinate"
   - Baut eine Übersichtstabelle mit festen Kopfspalten (Gebäude + Einheiten)
   - Sortiert die Koordinaten nach "Datum des letzten Eintrags" (neueste zuerst)
   ============================ */

// ---------- Storage keys ----------
const STORAGE_KEYS = {
  HOST_CSV: 'kb_host_csv_v1',
  REPORTS: 'kb_reports_v1' // optional: falls später Reports gespeichert werden
};

// ---------- Vordefinierte Spalten (Kopf) ----------
const TABLE_COLUMNS = [
  // erste Pflichtfelder
  'Koordinate',
  'DatumLetzterEintrag',
  // Gebäude (wie gewünscht)
  'Haupthaus','Goldbergwerk','Steinbruch','Holzfällerhütte','Universität','Baracke','Werft','Lagerhaus','Steinwall','Wachturm','Ruhestätte',
  // Einheiten (wie gewünscht)
  'Fregatte','Handelskogge','Kolonisationsschiff','Spähschiff','Steinschleuderer','Lanzenträger','Langbogenschütze','Kanonen'
];

// ---------- Hilfsfunktionen ----------
const $ = id => document.get