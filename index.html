<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Allianz Dashboard</title>

<!-- Firebase (modular v10) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, getDocs, query } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  /* ===================== Basic UI Helpers ===================== */
  const $ = (id)=>document.getElementById(id);

  /* ===================== Theme / Styles ===================== */
</script>

<style>
:root{
  --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
  --accent:#3b82f6; --accent-2:#2563eb; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --magenta:#e879f9;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
h1,h2,h3{margin:0}
.hidden{display:none}

.container{max-width:1200px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.2);padding:16px;margin-bottom:16px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.spacer{flex:1}

input,button,select{border-radius:8px;border:1px solid var(--border);background:#0b1220;color:var(--text);padding:10px 12px;font-size:14px}
button{background:var(--accent);border-color:transparent;cursor:pointer}
button:hover{background:var(--accent-2)}
button.ghost{background:transparent;border-color:var(--border)}
button.ghost:hover{background:#0b1220}
button.warn{background:var(--warn);border-color:transparent}
button.ok{background:var(--ok);border-color:transparent}
button.danger{background:var(--danger);border-color:transparent}

.tabbar{display:flex;gap:8px;margin-top:10px}
.tabbar button{border-radius:10px}
.tabcontent{margin-top:12px}

.badge{font-size:12px;color:var(--muted)}
.sep{height:1px;background:var(--border);margin:8px 0}

/* Tabelle */
.tablewrap{position:relative;overflow:auto;border-radius:10px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
th{position:sticky;top:0;background:#0b1220;color:var(--muted);cursor:pointer}
tr.requested{background:rgba(245,158,11,.12)}
tr.approved{background:rgba(34,197,94,.12)}
tr.denied{background:rgba(239,68,68,.12)}

/* Filter-Dropdown */
.col-filter{position:absolute;min-width:240px;background:#0b1220;border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.4);padding:8px;z-index:40}
.col-filter .options{max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:4px}
.option-row{display:flex;gap:6px;align-items:center;font-size:13px;padding:4px 6px}
.filter-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

/* Map */
#mapCanvas{display:block;width:100%;height:auto;background:#0b1220;border:1px solid var(--border);border-radius:10px;cursor:grab}
#mapCanvas:active{cursor:grabbing}
.legend{display:flex;gap:16px;align-items:center;color:var(--muted);font-size:13px}
.sw{width:12px;height:12px;border:1px solid var(--border);border-radius:2px;display:inline-block}
</style>
</head>

<body>
<div class="container">
  <h1>üèù Allianz Dashboard</h1>

  <!-- LOGIN -->
  <div id="loginView" class="card">
    <h2>Login / Registrierung</h2>
    <div class="row" style="margin-top:8px">
      <input id="username" placeholder="Ingame-Name (z.B. Max)" />
      <input id="password" type="password" placeholder="Passwort" />
      <button id="btnLogin">Anmelden</button>
      <button id="btnRegister" class="ghost">Registrieren</button>
      <span class="spacer"></span>
      <span class="badge">Login mit Fake-E-Mail (aus Ingame-Name)</span>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="hidden">
    <div class="card">
      <div class="row">
        <div>üë§ <b id="userDisplay">‚Äì</b> ‚Ä¢ Rolle: <b id="roleDisplay">‚Äì</b> ‚Ä¢ Status: <b id="statusDisplay">‚Äì</b></div>
        <span class="spacer"></span>
        <button id="btnLogout" class="ghost">Abmelden</button>
      </div>
      <div class="tabbar">
        <button data-tab="tab-map">üó∫ Inselkarte</button>
        <button data-tab="tab-islands">üìä Insel√ºbersicht</button>
        <button data-tab="tab-members" id="tabMembersBtn" class="hidden">üë• Mitglieder</button>
      </div>
    </div>

    <!-- TAB: MAP -->
    <div id="tab-map" class="tabcontent card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="legend">
          <span><span class="sw" style="background:#9aa3c7"></span> kein Spieler</span>
          <span><span class="sw" style="background:var(--magenta)"></span> keine Allianz</span>
          <span>Farben = Allianzen</span>
        </div>
        <div class="badge">Zoom: Mausrad ‚Ä¢ Verschieben: ziehen</div>
      </div>
      <canvas id="mapCanvas" width="1600" height="1600"></canvas>
      <div class="badge" style="margin-top:6px">Ozeane: rot ‚Ä¢ Inselgruppen: dunkelgrau ‚Ä¢ Inseln: hellgrau ‚Ä¢ IG-Nummern erscheinen ab mittlerem Zoom</div>
    </div>

    <!-- TAB: ISLANDS -->
    <div id="tab-islands" class="tabcontent card hidden">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <div class="row">
          <button id="btnResetFilters" class="ghost">Filter zur√ºcksetzen</button>
        </div>
        <div class="row">
          <input type="file" id="csvInput" accept=".csv" class="hidden">
          <button id="btnCSV" class="hidden">CSV hochladen (Admin)</button>
          <span id="csvStatus" class="badge"></span>
        </div>
      </div>
      <div class="tablewrap">
        <table id="islandTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tbodyRows"></tbody>
        </table>
        <div id="filterDropdown" class="col-filter hidden"></div>
      </div>
      <div id="tableStatus" class="badge" style="margin-top:6px"></div>
    </div>

    <!-- TAB: MEMBERS -->
    <div id="tab-members" class="tabcontent card hidden">
      <h3>Mitgliederverwaltung</h3>
      <div id="membersTable" style="margin-top:6px"></div>
      <div class="sep"></div>
      <div class="badge">Hinweis: ‚ÄûL√∂schen‚Äú entfernt den Firestore-Eintrag. Das Auth-Konto bitte separat in der Firebase Console l√∂schen.</div>
    </div>
  </div>
</div>

<script type="module">
/* ===================== Firebase Setup (modular) ===================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, getDocs, query } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const usersRef = collection(db,"users");
const metaRef  = collection(db,"meta");
const islandsRef = collection(db,"islands");
const reservationsRef = collection(db,"reservations");

/* ===================== State ===================== */
let currentUser=null, currentRole="member", currentStatus="pending";
let islands=[], viewData=[], reservations={};

const headers = [
  { key:"Ozean",           label:"Oz",            type:"number" },
  { key:"Inselgruppe",     label:"IG",            type:"number" },
  { key:"Insel",           label:"I",             type:"number" },
  { key:"Spielername",     label:"Spielername",   type:"text"   },
  { key:"AllianzKuerzel",  label:"Allianzk√ºrzel", type:"text"   },
  { key:"Punkte",          label:"Punkte",        type:"number" },
  { key:"__reserved_by",   label:"Reserviert von",type:"text", readonly:true },
  { key:"__action",        label:"Aktion",        type:"text", readonly:true },
];
const columnFilters = {}; headers.forEach(h=>columnFilters[h.key]=null);
let sortState = { key:null, dir:1 };

/* ===================== Helpers ===================== */
const $ = (id)=>document.getElementById(id);
function fakeEmail(name){
  return name.trim().toLowerCase()
    .replace(/[√§]/g,"ae").replace(/[√∂]/g,"oe").replace(/[√º]/g,"ue").replace(/[√ü]/g,"ss")
    .replace(/[^\w]+/g,"_")+"@alliancesystem.fake";
}
function numberify(x){
  if (typeof x === "number") return x;
  if (!x) return 0;
  return Number(String(x).replace(/^"|"$/g,"").replace(/\./g,"").replace(/\s/g,"").replace(/[^0-9-]/g,""))||0;
}

/* ===================== UI: Tabs ===================== */
const tabs = ["tab-map","tab-islands","tab-members"];
document.querySelectorAll(".tabbar button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const id = btn.getAttribute("data-tab");
    tabs.forEach(t=>$(t).classList.add("hidden"));
    $(id).classList.remove("hidden");
    if (id==="tab-map") drawMap();
  });
});

/* ===================== Auth: Login/Register/Logout ===================== */
$("btnLogin").onclick = async ()=>{
  const n=$("username").value.trim(), p=$("password").value.trim();
  if(!n||!p) return alert("Bitte Ingame-Name & Passwort eingeben!");
  try{ await signInWithEmailAndPassword(auth, fakeEmail(n), p); }catch(e){ alert(e.message); }
};
$("btnRegister").onclick = async ()=>{
  const n=$("username").value.trim(), p=$("password").value.trim();
  if(!n||!p) return alert("Bitte Ingame-Name & Passwort eingeben!");
  try{
    await createUserWithEmailAndPassword(auth, fakeEmail(n), p);
    const uid = auth.currentUser.uid;

    // Bootstrap: versuche /meta/config einmalig anzulegen
    const metaCfg = doc(db,"meta","config");
    let first=false;
    try {
      // create-√§hnlich: ohne merge ‚Äî schl√§gt fehl, wenn existiert
      await setDoc(metaCfg, { adminInitialized:true, createdAt:new Date(), bootstrapBy:n }, { merge:false });
      first=true;
    } catch(_) { /* existiert bereits */ }

    await setDoc(doc(db,"users",uid), {
      uid, ingameName:n,
      role: first ? "admin" : "member",
      status: first ? "active" : "pending",
      createdAt:new Date()
    }, { merge:true });

    alert(first ? "Erster Benutzer erkannt. Admin & aktiv!" : "Registriert. Bitte auf Freischaltung warten.");
  }catch(e){ alert(e.message); }
};
$("btnLogout").onclick = async ()=>{ await signOut(auth); location.reload(); };

/* ===================== Auth State + Fallback ===================== */
onAuthStateChanged(auth, async (u)=>{
  if(!u) return;

  // kleine Verz√∂gerung
  await new Promise(r=>setTimeout(r,300));

  const uid = u.uid;
  const userDoc = doc(db,"users",uid);
  const metaDoc = doc(db,"meta","config");

  // Fallback: meta/config fehlt ‚Üí wir legen sie an und machen diesen Benutzer Admin+active
  const metaSnap = await getDoc(metaDoc);
  if (!metaSnap.exists()) {
    try{
      await setDoc(metaDoc,{ adminInitialized:true, createdAt:new Date(), bootstrapBy: u.email }, { merge:false });
      await setDoc(userDoc, { role:"admin", status:"active" }, { merge:true });
    }catch(e){ /* ignore */ }
  }

  // User laden / ggf. Minimalprofil
  let uSnap = await getDoc(userDoc);
  if (!uSnap.exists()) {
    await setDoc(userDoc, { uid, ingameName: u.email.split("@")[0].replace(/_/g," "), role:"member", status:"pending", createdAt:new Date() });
    uSnap = await getDoc(userDoc);
  }

  const data = uSnap.data();
  currentUser = { ...u, uid, ingameName: data.ingameName || u.email.split("@")[0].replace(/_/g," ") };
  currentRole  = data.role  || "member";
  currentStatus= data.status|| "pending";

  if (currentStatus!=="active") {
    alert("Dein Account ist nicht freigeschaltet.");
    await signOut(auth); return;
  }

  // UI freigeben
  $("loginView").classList.add("hidden");
  $("appView").classList.remove("hidden");
  $("userDisplay").textContent = currentUser.ingameName;
  $("roleDisplay").textContent = currentRole;
  $("statusDisplay").textContent= "AKTIV";
  if (currentRole==="admin"){ $("tabMembersBtn").classList.remove("hidden"); $("btnCSV").classList.remove("hidden"); }

  // Daten und Listener
  await loadIslands();
  listenReservations();
  buildTableHeader();
  renderTable();
  drawMap();

  // Admin: Mitglieder
  if (currentRole==="admin") listenMembers();
});

/* ===================== CSV Upload (Admin only) ===================== */
$("btnCSV").onclick = ()=> $("csvInput").click();
$("csvInput").addEventListener("change", async (e)=>{
  if (currentRole!=="admin") return alert("Nur Admin darf CSV hochladen.");
  const f = e.target.files[0]; if(!f) return;
  $("csvStatus").textContent = "Importiere CSV...";
  const txt = await f.text();
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows  = lines.map(line => line.split(";").map(v => v.replace(/^"|"$/g,"").trim()));
  const mapped = rows.map(c=>({
    Ozean: c[0]||"", Inselgruppe:c[1]||"", Insel:c[2]||"", Inselname:c[3]||"",
    SpielerID:c[4]||"", Spielername:c[5]||"", AllianzID:c[6]||"", AllianzKuerzel:c[7]||"",
    Allianzname:c[8]||"", Punkte: numberify(c[9]||0)
  }));

  // Komplett-Replace: vorhandene Inseln lokal l√∂schen & neu schreiben (Batch ersatzlos √ºbersprungen, modular SDK: nutzerdefiniert)
  // F√ºr Einfachheit: existierende lesen und √ºberschreiben (hier Demo: Nur neu setzen unter synthetischer ID)
  let i=0;
  for (const r of mapped){
    // synthetische ID stabilisieren:
    const id = `${r.Ozean||'0'}-${r.Inselgruppe||'0'}-${r.Insel||'0'}-${i++}`;
    await setDoc(doc(db,"islands",id), r);
  }
  $("csvStatus").textContent = "CSV hochgeladen.";
  await loadIslands();
  resetFilters();
  renderTable();
  drawMap();
});

/* ===================== Load Islands + Reservations ===================== */
async function loadIslands(){
  const snap = await getDocs(query(islandsRef));
  islands = snap.docs.map(d=>d.data()).map(row=>{
    const out={}; for(const k in row){
      out[k] = typeof row[k]==="string" ? row[k].replace(/^"|"$/g,"").trim() : row[k];
    }
    out.Punkte = numberify(out.Punkte);
    return out;
  });
  viewData = [...islands];
}
function listenReservations(){
  onSnapshot(reservationsRef, (s)=>{
    reservations={}; s.forEach(d=> reservations[d.id]=d.data() );
    renderTable();
    if (!$("tab-map").classList.contains("hidden")) drawMap();
  });
}

/* ===================== Table: Header, Filters, Sort ===================== */
function buildTableHeader(){
  const tr = $("theadRow"); tr.innerHTML="";
  headers.forEach(h=>{
    const th=document.createElement("th");
    th.textContent=h.label; th.dataset.key=h.key;
    th.onclick = (e)=>{ if(!h.readonly) showFilter(h, th); toggleSort(h.key); };
    tr.appendChild(th);
  });

  // Outside click hides dropdown
  document.addEventListener("click",(e)=>{
    const dd=$("filterDropdown");
    if(dd.classList.contains("hidden")) return;
    if(!dd.contains(e.target) && !e.target.closest("th")) dd.classList.add("hidden");
  });

  $("btnResetFilters").onclick = ()=>{ resetFilters(); renderTable(); };
}
function resetFilters(){ Object.keys(columnFilters).forEach(k=>columnFilters[k]=null); sortState={key:null,dir:1}; }
function toggleSort(key){
  if (sortState.key===key) sortState.dir*=-1;
  else { sortState.key=key; sortState.dir=1; }
  renderTable();
}
function renderTable(){
  // filter
  const filtered = islands.filter(row=>{
    const resid = `${row.Ozean}-${row.Inselgruppe}-${row.Insel}`;
    const res = reservations[resid];
    row.__reserved_by = res?.user || "";
    row.__status      = res?.status || "";

    for(const h of headers){
      const sel = columnFilters[h.key];
      if (!sel) continue;
      const value = (h.key==="__reserved_by") ? row.__reserved_by : (row[h.key] ?? "");
      const valStr = h.type==="number" ? String(numberify(value)) : String(value);
      if (!sel.has(valStr)) return false;
    }
    return true;
  });

  // sort
  if (sortState.key){
    const h = headers.find(x=>x.key===sortState.key);
    const k = sortState.key, dir = sortState.dir;
    filtered.sort((a,b)=>{
      const va = (k==="__reserved_by")? (a.__reserved_by||"") : (a[k]??"");
      const vb = (k==="__reserved_by")? (b.__reserved_by||"") : (b[k]??"");
      if (h?.type==="number") return (numberify(va)-numberify(vb))*dir;
      return String(va).localeCompare(String(vb),'de',{numeric:true})*dir;
    });
  }

  viewData = filtered;
  // body render
  const tb = $("tbodyRows"); tb.innerHTML="";
  filtered.forEach(row=>{
    const resid=`${row.Ozean}-${row.Inselgruppe}-${row.Insel}`;
    const res=reservations[resid];
    const tr=document.createElement("tr");
    if(res?.status) tr.classList.add(res.status);

    headers.forEach(h=>{
      const td=document.createElement("td");
      if (h.key==="__reserved_by") td.textContent = res?.user || "-";
      else if (h.key==="__action") td.innerHTML = actionCell(resid,res);
      else if (h.key==="Punkte")   td.textContent = numberify(row.Punkte).toLocaleString('de-DE');
      else td.textContent = (row[h.key]??"").toString();
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });

  // status
  $("tableStatus").textContent = `${filtered.length} von ${islands.length} Eintr√§gen`
    + (sortState.key ? ` ‚Ä¢ Sortiert: ${headers.find(h=>h.key===sortState.key).label} (${sortState.dir===1?'‚Üë':'‚Üì'})` : "");
}
function actionCell(key,res){
  if(!currentUser) return `<button disabled>Login n√∂tig</button>`;
  if(currentStatus!=="active") return `<button disabled>Gesperrt/Ausstehend</button>`;

  // Bereits vorhanden?
  if(res){
    if(res.status==="requested"){
      if(currentRole==="admin"){
        return `<div class="row"><span>von ${res.user}</span><button class="ok" onclick="approve('${key}')">‚úî</button><button class="ghost" onclick="deny('${key}')">‚úñ</button></div>`;
      }
      if(res.reservedBy===currentUser.uid) return `<button disabled>Reserviert (wartet)</button>`;
      return `<button disabled>Reserviert von ${res.user}</button>`;
    }
    if(res.status==="approved"){
      if(res.reservedBy===currentUser.uid) return `<button disabled>‚úÖ Best√§tigt</button>`;
      return `<button disabled>Reserviert von ${res.user}</button>`;
    }
    if(res.status==="denied"){
      return `<button onclick="reserve('${key}')">Reservieren</button>`;
    }
  }
  // Keine Reservierung vorhanden
  return `<button onclick="reserve('${key}')">Reservieren</button>`;
}
function showFilter(header, thEl){
  const key=header.key, dd=$("filterDropdown");
  dd.innerHTML=""; dd.classList.remove("hidden");

  const rect=thEl.getBoundingClientRect(), wrap=thEl.closest(".tablewrap").getBoundingClientRect();
  dd.style.left=(rect.left-wrap.left)+"px"; dd.style.top=(rect.bottom-wrap.top+4)+"px";

  // Werte sammeln
  const vals = new Set(islands.map(r=>{
    let v = (key==="__reserved_by") ? "" : (r[key]??"");
    if (header.type==="number") v = String(numberify(v));
    return String(v);
  }));
  const items = Array.from(vals).sort((a,b)=> header.type==="number" ? (Number(a)-Number(b)) : a.localeCompare(b,'de',{numeric:true}));
  const active = columnFilters[key] ? new Set(Array.from(columnFilters[key])) : null;

  const title=document.createElement("div"); title.style.color="var(--muted)"; title.style.margin="4px 2px"; title.textContent=`Filter: ${header.label}`; dd.appendChild(title);

  const ctrl=document.createElement("div"); ctrl.className="row"; ctrl.style.margin="6px 0";
  const btnAll=document.createElement("button"); btnAll.className="ghost"; btnAll.textContent="Alle an/aus";
  const btnClear=document.createElement("button"); btnClear.className="ghost"; btnClear.textContent="Leeren";
  ctrl.appendChild(btnAll); ctrl.appendChild(btnClear); dd.appendChild(ctrl);

  const list=document.createElement("div"); list.className="options"; dd.appendChild(list);
  const refs=[];
  for(const v of items){
    const r=document.createElement("div"); r.className="option-row";
    const cb=document.createElement("input"); cb.type="checkbox"; cb.checked = active? active.has(v) : true; cb.dataset.val=v;
    const lab=document.createElement("label"); lab.textContent= v==="" ? "(leer)" : (header.type==="number" ? Number(v).toLocaleString('de-DE') : v);
    r.appendChild(cb); r.appendChild(lab); list.appendChild(r); refs.push(cb);
  }

  const actions=document.createElement("div"); actions.className="filter-actions";
  const btnApply=document.createElement("button"); btnApply.textContent="Anwenden";
  const btnCancel=document.createElement("button"); btnCancel.className="ghost"; btnCancel.textContent="Abbrechen";
  actions.appendChild(btnApply); actions.appendChild(btnCancel); dd.appendChild(actions);

  btnAll.onclick=()=>{ const someUnchecked=refs.some(c=>!c.checked); refs.forEach(c=>c.checked=someUnchecked); };
  btnClear.onclick=()=> refs.forEach(c=>c.checked=false);
  btnCancel.onclick=()=> dd.classList.add("hidden");
  btnApply.onclick=()=>{
    const sel=refs.filter(c=>c.checked).map(c=>c.dataset.val);
    if (sel.length===items.length || sel.length===0) columnFilters[key]=null; else columnFilters[key]=new Set(sel);
    dd.classList.add("hidden"); renderTable();
  };
}

/* ===================== Reservations Actions ===================== */
window.reserve = async (key)=>{
  if(currentStatus!=="active") return alert("Nicht freigeschaltet.");
  // Pr√ºfen ob bereits vorhanden (au√üer denied)
  const id = key; // nutze key direkt als reservations doc id
  const ref = doc(db,"reservations",id);
  const s = await getDoc(ref);
  if (s.exists() && s.data().status!=="denied") return alert("Bereits reserviert.");
  await setDoc(ref, { islandId:key, reservedBy:currentUser.uid, user:currentUser.ingameName, status:"requested", timestamp:new Date() }, { merge:true });
};
window.approve = async (key)=>{
  if(currentRole!=="admin") return;
  await setDoc(doc(db,"reservations",key), { status:"approved" }, { merge:true });
};
window.deny = async (key)=>{
  if(currentRole!=="admin") return;
  await setDoc(doc(db,"reservations",key), { status:"denied" }, { merge:true });
};

/* ===================== Members (Admin) ===================== */
function listenMembers(){
  onSnapshot(usersRef, (snap)=>{
    const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
    let html = `<div class="tablewrap"><table><thead><tr>
      <th>Name</th><th>Rolle</th><th>Status</th><th>Aktion</th></tr></thead><tbody>`;
    arr.forEach(u=>{
      const style = u.status==="pending" ? 'style="background:rgba(245,158,11,.12)"'
                  : u.status==="blocked" ? 'style="background:rgba(239,68,68,.12)"'
                  : 'style="background:rgba(34,197,94,.12)"';
      html += `<tr ${style}>
        <td>${u.ingameName||u.id}</td>
        <td>${u.role||'member'}</td>
        <td>${u.status||'pending'}</td>
        <td>
          ${u.role==='admin'
            ? `<button class="ghost" onclick="setRole('${u.id}','member')">‚¨á Mitglied</button>`
            : `<button onclick="setRole('${u.id}','admin')">‚¨Ü Admin</button>`}
          ${u.status==='pending'
            ? `<button class="ok" onclick="setStatus('${u.id}','active')">Freischalten</button>`
            : u.status==='active'
              ? `<button class="ghost" onclick="setStatus('${u.id}','blocked')">Sperren</button>`
              : `<button class="ok" onclick="setStatus('${u.id}','active')">Entsperren</button>`}
          <button class="danger" onclick="deleteUserDoc('${u.id}')">L√∂schen</button>
        </td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
    $("membersTable").innerHTML = html;
  });
}
window.setRole = async (uid, role)=> await setDoc(doc(db,"users",uid), { role }, { merge:true });
window.setStatus= async (uid, st)=> await setDoc(doc(db,"users",uid), { status:st }, { merge:true });
window.deleteUserDoc = async(uid)=>{
  if(!confirm("Firestore-Eintrag l√∂schen?")) return;
  await setDoc(doc(db,"users",uid), {}, { merge:false });
  // In real: deleteDoc(doc(db,"users",uid))
  alert("Firestore-Datensatz entfernt. Auth-Account bitte in der Konsole l√∂schen.");
};

/* ===================== Map (Zoom + Pan + Layer) ===================== */
let mapZoom=1.0, mapOffsetX=0, mapOffsetY=0, dragging=false, dragStart={x:0,y:0};
const mapCanvas=$("mapCanvas"), ctx=mapCanvas.getContext("2d");
mapCanvas.addEventListener("wheel", e=>{
  e.preventDefault();
  const z=(e.deltaY<0)?1.1:0.9;
  mapZoom=Math.min(Math.max(mapZoom*z,0.4),10);
  drawMap();
});
mapCanvas.addEventListener("mousedown",(e)=>{ dragging=true; dragStart={x:e.clientX-mapOffsetX,y:e.clientY-mapOffsetY}; });
window.addEventListener("mouseup",()=> dragging=false);
mapCanvas.addEventListener("mousemove",(e)=>{
  if(!dragging)return;
  mapOffsetX=e.clientX - dragStart.x;
  mapOffsetY=e.clientY - dragStart.y;
  drawMap();
});

function drawMap(){
  const c=ctx, W=mapCanvas.width, H=mapCanvas.height;
  c.clearRect(0,0,W,H);
  const TOTAL=120, base=8, cell=base*mapZoom;
  const x0=40+mapOffsetX, y0=40+mapOffsetY;

  // Hintergrund
  c.fillStyle="#0b1220"; c.fillRect(0,0,W,H);

  // Allianzfarben
  const palette={}; const magenta=getComputedStyle(document.documentElement).getPropertyValue("--magenta").trim();
  function hslToHex(h,s,l){s/=100;l/=100;const k=n=>(n+h/30)%12,a=s*Math.min(l,1-l);const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));const to=x=>Math.round(x*255).toString(16).padStart(2,"0");return `#${to(f(0))}${to(f(8))}${to(f(4))}`;}
  function colOf(ak){ if(!ak) return "#9aa3c7"; if(palette[ak]) return palette[ak]; let h=0; for(let i=0;i<ak.length;i++) h=(h*31+ak.charCodeAt(i))>>>0; return palette[ak]=hslToHex(h%360,60,55); }

  // Inselzellen
  islands.forEach(r=>{
    const oz = Math.max(1,Math.min(4,parseInt(r.Ozean)||1));
    const IG = Math.max(1,Math.min(225,parseInt(r.Inselgruppe)||1));
    const ins= Math.max(1,Math.min(16,parseInt(r.Insel)||1));
    const oColOff = (oz===1||oz===3) ? 0 : 60;
    const oRowOff = (oz===1||oz===2) ? 0 : 60;
    const igc=(IG-1)%15, igr=Math.floor((IG-1)/15);
    const inc=(ins-1)%4, inr=Math.floor((ins-1)/4);
    const col=oColOff+igc*4+inc, row=oRowOff+igr*4+inr;
    const x=x0+col*cell, y=y0+row*cell;

    const name=(r.Spielername||"").trim();
    const ak=(r.AllianzKuerzel||"").trim();
    let fill="#9aa3c7"; if(name) fill = ak ? colOf(ak) : magenta;

    c.fillStyle=fill; c.fillRect(x,y,cell,cell);
  });

  // Insel-Gitter (hellgrau)
  if (mapZoom>0.3){
    c.strokeStyle="#999"; c.lineWidth=0.3;
    for(let i=0;i<=TOTAL;i++){
      const yy=y0+i*cell; c.beginPath(); c.moveTo(x0,yy); c.lineTo(x0+TOTAL*cell,yy); c.stroke();
      const xx=x0+i*cell; c.beginPath(); c.moveTo(xx,y0); c.lineTo(xx,y0+TOTAL*cell); c.stroke();
    }
  }
  // IG-Gitter (dunkelgrau)
  c.strokeStyle="#666"; c.lineWidth=0.7;
  for(let i=0;i<=TOTAL;i+=4){
    c.beginPath(); c.moveTo(x0,y0+i*cell); c.lineTo(x0+TOTAL*cell,y0+i*cell); c.stroke();
    c.beginPath(); c.moveTo(x0+i*cell,y0); c.lineTo(x0+i*cell,y0+TOTAL*cell); c.stroke();
  }
  // Ozean-Trenner (rot)
  c.strokeStyle="rgba(255,0,0,0.8)"; c.lineWidth=1.2;
  c.beginPath();
  c.moveTo(x0+60*cell,y0); c.lineTo(x0+60*cell,y0+120*cell);
  c.moveTo(x0,y0+60*cell); c.lineTo(x0+120*cell,y0+60*cell);
  c.stroke();

  // IG-Nummern
  if (mapZoom>1.2){
    c.fillStyle="#e5e7eb"; c.font=`${Math.max(8,cell*1.1)}px sans-serif`;
    for(let i=0;i<225;i++){
      const igc=i%15, igr=Math.floor(i/15);
      const cx=x0+igc*4*cell+2*cell, cy=y0+igr*4*cell+2*cell;
      c.fillText(String(i+1), cx-6, cy+4);
    }
  }
}

/* ===================== Default Tab ===================== */
document.querySelector('[data-tab="tab-map"]').click();
</script>
</body>
</html>