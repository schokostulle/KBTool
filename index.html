<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Allianz-Kampfberichte</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea { width: 100%; height: 100px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    .hidden { display: none; }
  </style>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Allianz-Kampfberichte</h1>

<!-- Registrierung / Login -->
<div id="authDiv">
  <h3>Registrieren</h3>
  <input type="email" id="regEmail" placeholder="Email">
  <input type="password" id="regPass" placeholder="Passwort">
  <button id="registerBtn">Registrieren</button>

  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPass" placeholder="Passwort">
  <button id="loginBtn">Login</button>
</div>

<!-- Kampfberichte -->
<div id="reportDiv" class="hidden">
  <h3>Kampfbericht einfügen</h3>
  <textarea id="reportText" placeholder="Kampfbericht hier einfügen"></textarea>
  <button id="submitReportBtn">Absenden</button>

  <h3>Alle Berichte</h3>
  <div id="reportsTable"></div>

  <h3>Aggregierte Übersicht</h3>
  <table id="aggregateTable">
    <thead>
      <tr>
        <th>Einheit/Gebäude</th>
        <th>Anzahl / Level</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="logoutBtn">Logout</button>
</div>

<script>
  // ====== Firebase Config ======
  const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const authDiv = document.getElementById("authDiv");
  const reportDiv = document.getElementById("reportDiv");

  // ====== Registrierung ======
  document.getElementById("registerBtn").addEventListener("click", async () => {
    const email = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPass").value;
    try {
      await auth.createUserWithEmailAndPassword(email, pass);
      alert("Registrierung erfolgreich!");
    } catch (e) { alert(e.message); }
  });

  // ====== Login ======
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("loginEmail").value;
    const pass = document.getElementById("loginPass").value;
    try {
      await auth.signInWithEmailAndPassword(email, pass);
    } catch (e) { alert(e.message); }
  });

  // ====== Logout ======
  document.getElementById("logoutBtn").addEventListener("click", () => {
    auth.signOut();
  });

  // ====== Auth State Listener ======
  auth.onAuthStateChanged(user => {
    if (user) {
      authDiv.classList.add("hidden");
      reportDiv.classList.remove("hidden");
      renderReports();
    } else {
      authDiv.classList.remove("hidden");
      reportDiv.classList.add("hidden");
    }
  });

  // ====== Kampfbericht absenden ======
  document.getElementById("submitReportBtn").addEventListener("click", async () => {
    const text = document.getElementById("reportText").value;
    const user = auth.currentUser;
    if (!user) return alert("Bitte einloggen!");
    await db.collection("reports").add({
      userId: user.uid,
      text,
      date: new Date()
    });
    document.getElementById("reportText").value = "";
    renderReports();
  });

  // ====== Reports anzeigen & aggregieren ======
  async function renderReports() {
    const snapshot = await db.collection("reports").orderBy("date", "desc").get();
    const reportsTable = document.getElementById("reportsTable");
    const aggregateTableBody = document.querySelector("#aggregateTable tbody");
    reportsTable.innerHTML = "";
    aggregateTableBody.innerHTML = "";

    const aggregate = {}; // z.B. {"Fregatte": 0, "Hauptgebäude": 0}

    snapshot.docs.forEach(doc => {
      const data = doc.data();
      reportsTable.innerHTML += `<p><strong>${data.date.toDate().toLocaleString()}</strong>: ${data.text}</p>`;

      // ====== Einfache Parsing-Logik ======
      const lines = data.text.split("\n");
      lines.forEach(line => {
        const match = line.match(/(\w+)[:\s]*\d+/);
        if (match) {
          const key = match[1];
          const valueMatch = line.match(/\d+/g);
          if (valueMatch) {
            const value = parseInt(valueMatch[valueMatch.length-1]);
            aggregate[key] = (aggregate[key] || 0) + value;
          }
        }
      });
    });

    // Aggregierte Tabelle
    for (const [key, value] of Object.entries(aggregate)) {
      aggregateTableBody.innerHTML += `<tr><td>${key}</td><td>${value}</td></tr>`;
    }
  }
</script>

</body>
</html>