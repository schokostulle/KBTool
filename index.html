<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Allianz-Dashboard</title>
<style>
:root{
  --bg:#0d1117;--card:#161b22;--text:#e6edf3;--muted:#8b949e;--border:#30363d;
  --accent:#60a5fa;--accent-2:#3b82f6;--ok:#22c55e;--warn:#fbbf24;--danger:#ef4444;--magenta:#e879f9;
  --map-bg:#0b1220;--grid-i:#6b7280;--grid-ig:#3f3f46;--grid-o:rgba(255,70,70,.8);
}
:root.light{
  --bg:#f9fafb;--card:#fff;--text:#111827;--muted:#374151;--border:#d1d5db;
  --accent:#3b82f6;--accent-2:#2563eb;--ok:#16a34a;--warn:#d97706;--danger:#dc2626;--magenta:#db2777;
  --map-bg:#f3f4f6;--grid-i:#d1d5db;--grid-ig:#9ca3af;--grid-o:rgba(239,68,68,.4);
}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif;transition:.25s}
.hidden{display:none}.muted{color:var(--muted)}
.header{position:sticky;top:0;z-index:50;background:var(--card);border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;padding:10px 16px}
.header .spacer{flex:1}
.container{max-width:1200px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.2);padding:16px;margin-top:16px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.spacer{flex:1}.badge{font-size:13px;color:var(--muted)}
button,input,select{border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;font-size:14px}
button{background:var(--accent);border:none;cursor:pointer}button:hover{background:var(--accent-2)}
button.ghost{background:transparent;border:1px solid var(--border)}button.ok{background:var(--ok)}button.warn{background:var(--warn)}button.danger{background:var(--danger)}
.tabbar{display:flex;gap:8px;margin-top:8px}.tabcontent{margin-top:12px}
.tablewrap{overflow:auto;border-radius:10px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid var(--border);white-space:nowrap}
th{position:sticky;top:0;background:var(--card);color:var(--muted);cursor:pointer}
tr.requested{background:rgba(251,191,36,.12)}tr.approved{background:rgba(34,197,94,.12)}tr.denied{background:rgba(239,68,68,.12)}
.col-filter{position:absolute;background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.4);padding:8px;z-index:40}
.col-filter .options{max-height:240px;overflow:auto}
.option-row{display:flex;gap:6px;align-items:center;font-size:13px;padding:4px 0}
.filter-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
@media (max-width:900px){
  table,thead,tbody,th,td,tr{display:block;width:100%}
  th{display:none}tr{border-bottom:1px solid var(--border);margin-bottom:8px;padding:6px 0}
  td{display:flex;justify-content:space-between;padding:6px 10px}
  td::before{content:attr(data-label);font-weight:600;color:var(--muted)}
}
#mapCanvas{display:block;width:100%;max-width:100%;height:auto;background:var(--map-bg);border:1px solid var(--border);border-radius:12px}
.legend{display:flex;gap:12px;align-items:center;font-size:13px;color:var(--muted);flex-wrap:wrap}
.sw{width:12px;height:12px;border:1px solid var(--border);border-radius:2px;display:inline-block}
</style>
</head>
<body>
  <div class="header">
    <div><b>üèù Allianz-Dashboard</b></div>
    <div class="spacer"></div>
    <button id="btnTheme" class="ghost">üåô Dark</button>
  </div>

  <div class="container">
    <div id="loginView" class="card">
      <h2>Login / Registrierung</h2>
      <div class="row"><input id="username" placeholder="Ingame-Name"><input id="password" type="password" placeholder="Passwort"></div>
      <div class="row"><button id="btnLogin">Anmelden</button><button id="btnRegister" class="ghost">Registrieren</button><span class="badge">Erster Account wird Admin.</span></div>
    </div>

    <div id="appView" class="hidden">
      <div class="card row">
        <div>üë§ <b id="userDisplay">‚Äì</b> ‚Ä¢ Rolle: <b id="roleDisplay">‚Äì</b> ‚Ä¢ Status: <b id="statusDisplay">‚Äì</b></div>
        <div class="spacer"></div>
        <button id="btnLogout" class="ghost">Abmelden</button>
      </div>

      <div class="card">
        <div class="tabbar">
          <button data-tab="tab-islands">üìä Insel√ºbersicht</button>
          <button data-tab="tab-players">üßë‚Äç‚úàÔ∏è Spieler√ºbersicht</button>
          <button data-tab="tab-attack">‚öîÔ∏è Angriff / Verteidigung</button>
          <button data-tab="tab-map">üó∫ Inselkarte</button>
          <button data-tab="tab-diplomacy" id="tabDiplBtn" class="hidden">ü§ù Diplomatie (Admin)</button>
        </div>
      </div>

      <!-- Insel√ºbersicht -->
      <div id="tab-islands" class="tabcontent card">
        <div class="row" style="justify-content:space-between">
          <div class="row"><button id="btnResetFilters" class="ghost">Filter zur√ºcksetzen</button><span class="badge" id="tableStatus"></span></div>
          <div><input type="file" id="csvInput" accept=".csv" class="hidden"><button id="btnCSV" class="hidden">CSV hochladen (Admin)</button><span id="csvStatus" class="badge"></span></div>
        </div>
        <div class="tablewrap">
          <table id="islandTable"><thead><tr id="theadRow"></tr></thead><tbody id="tbodyRows"></tbody></table>
          <div id="filterDropdown" class="col-filter hidden"></div>
        </div>
      </div>

      <!-- Spieler√ºbersicht -->
      <div id="tab-players" class="tabcontent card hidden">
        <h3>Spieler√ºbersicht</h3>
        <div class="tablewrap">
          <table id="playerTable">
            <thead><tr><th>Spieler</th><th>Allianz</th><th>IG (sortiert)</th><th>Inseln</th><th>Punkte</th></tr></thead>
            <tbody id="playerTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Angriff / Verteidigung -->
      <div id="tab-attack" class="tabcontent card hidden">
        <h3>Angriff / Verteidigung</h3>
        <div class="row">
          <input id="atk_from" placeholder="Angreifende Insel z. B. 2:201:16">
          <input id="atk_to" placeholder="Zielinsel z. B. 1:171:5">
          <input id="atk_start" placeholder="Start HH:mm:ss">
          <select id="atk_unit">
            <option value="Sp√§hschiff">Sp√§hschiff (12 kn)</option>
            <option value="Fregatte">Fregatte (8 kn)</option>
            <option value="Handelskogge">Handelskogge (6 kn)</option>
            <option value="Kolonisationsschiff">Kolonisationsschiff (2 kn)</option>
          </select>
          <select id="atk_relation">
            <option value="friendly">Freundlich</option>
            <option value="hostile">Feindlich</option>
            <option value="neutral">Neutral</option>
          </select>
          <button id="atk_calc">Berechnen</button>
        </div>
        <div class="badge">Entfernung 1 Dezimalstelle ‚Ä¢ Zeit lokal ‚Ä¢ Reisezeit intern 5 Stellen (h) gerundet ‚Ä¢ Ausgabe HH:mm:ss</div>
        <div class="tablewrap" style="margin-top:8px">
          <table id="atkTable"><thead>
            <tr><th>Spieler</th><th>Startinsel</th><th>Zielinsel</th><th>Einheit</th><th>Distanz (sm)</th><th>Reisezeit</th><th>Ankunft</th><th>R√ºckkehr</th></tr>
          </thead><tbody id="atkTbody"></tbody></table>
        </div>
      </div>

      <!-- Inselkarte -->
      <div id="tab-map" class="tabcontent card hidden">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="legend">
            <span><span class="sw" style="background:#9aa3c7"></span> kein Spieler</span>
            <span><span class="sw" style="background:var(--magenta)"></span> allianzlos</span>
          </div>
          <div class="row">
            <select id="mapColorMode">
              <option value="diplomacy">Farben nach Diplomatie</option>
              <option value="points">Farben nach Punkten</option>
            </select>
            <span class="badge">K√§stchen: Spieler / K√ºrzel / Punkte</span>
          </div>
        </div>
        <canvas id="mapCanvas" width="1800" height="1800"></canvas>
      </div>

      <!-- Diplomatie -->
      <div id="tab-diplomacy" class="tabcontent card hidden">
        <h3>Diplomatie verwalten</h3>
        <div class="row">
          <input id="ally_code" placeholder="Allianzk√ºrzel"><input id="ally_name" placeholder="Allianzname">
          <select id="ally_rel"><option value="friendly">freundlich</option><option value="hostile">feindlich</option><option value="neutral">neutral</option></select>
          <button id="ally_save">Speichern</button>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="pov_player" placeholder="Spielername (Override)">
          <select id="pov_rel"><option value="friendly">freundlich</option><option value="hostile">feindlich</option><option value="neutral">neutral</option></select>
          <button id="pov_save">Override speichern</button>
        </div>
        <div class="tablewrap" style="margin-top:12px">
          <table><thead><tr><th>K√ºrzel</th><th>Name</th><th>Beziehung</th></tr></thead><tbody id="allyTbody"></tbody></table>
        </div>
        <div class="tablewrap" style="margin-top:12px">
          <table><thead><tr><th>Spieler</th><th>Beziehung</th></tr></thead><tbody id="povTbody"></tbody></table>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $=id=>document.getElementById(id);
function fakeEmail(n){return n.trim().toLowerCase().replace(/[√§]/g,"ae").replace(/[√∂]/g,"oe").replace(/[√º]/g,"ue").replace(/[√ü]/g,"ss").replace(/[^\w]+/g,"_")+"@fake.local";}
function numberify(x){return Number(String(x??"").replace(/^"|"$/g,"").replace(/\./g,"").replace(/\s/g,""))||0;}
function round1(v){return Math.round(v*10)/10;}function round5(v){return Math.round(v*1e5)/1e5;}
const shipKnots={Sp√§hschiff:12,Fregatte:8,Handelskogge:6,Kolonisationsschiff:2};

let currentUser=null,currentRole="member",currentStatus="pending";
let islands=[],reservations={},allyMap={},playerOverrides={};

/* Theme */
(function(){const isLight=localStorage.theme==="light";document.documentElement.classList.toggle("light",isLight);$("btnTheme").textContent=isLight?"‚òÄÔ∏è Light":"üåô Dark";})();
$("btnTheme").onclick=()=>{const willLight=!document.documentElement.classList.contains("light");document.documentElement.classList.toggle("light",willLight);localStorage.theme=willLight?"light":"dark";$("btnTheme").textContent=willLight?"‚òÄÔ∏è Light":"üåô Dark";drawMap();};

/* Tabs */
const tabs=["tab-islands","tab-players","tab-attack","tab-map","tab-diplomacy"];
document.querySelectorAll(".tabbar button").forEach(b=>b.addEventListener("click",()=>{const id=b.getAttribute("data-tab");tabs.forEach(t=>$(t).classList.add("hidden"));$(id).classList.remove("hidden");if(id==="tab-map")drawMap();if(id==="tab-players")renderPlayers();}));

/* Auth */
$("btnRegister").onclick=async()=>{const n=$("username").value.trim(),p=$("password").value.trim();if(!n||!p)return alert("Name & Passwort!");try{const cred=await createUserWithEmailAndPassword(auth,fakeEmail(n),p);const all=await getDocs(collection(db,"users"));const first=all.empty;await setDoc(doc(db,"users",cred.user.uid),{name:n,role:first?"admin":"member",status:first?"active":"pending"});alert(first?"Admin erstellt.":"Registriert. Bitte Freischaltung abwarten.");}catch(e){alert(e.message);}};
$("btnLogin").onclick=async()=>{const n=$("username").value.trim(),p=$("password").value.trim();if(!n||!p)return alert("Name & Passwort!");try{await signInWithEmailAndPassword(auth,fakeEmail(n),p);}catch(e){alert(e.message);}};
$("btnLogout").onclick=()=>signOut(auth);

onAuthStateChanged(auth, async u=>{
  if(!u){$("loginView").classList.remove("hidden");$("appView").classList.add("hidden");return;}
  const d=await getDoc(doc(db,"users",u.uid)); if(!d.exists()){await signOut(auth);return;}
  const data=d.data(); if(data.status!=="active"){alert("Noch nicht freigeschaltet.");await signOut(auth);return;}
  currentUser=u; currentRole=data.role; currentStatus=data.status;
  $("loginView").classList.add("hidden");$("appView").classList.remove("hidden");
  $("userDisplay").textContent=data.name; $("roleDisplay").textContent=currentRole; $("statusDisplay").textContent="AKTIV";
  if(currentRole==="admin"){$("btnCSV").classList.remove("hidden");$("tabDiplBtn").classList.remove("hidden");}
  await Promise.all([loadIslands(), loadDiplomacy()]); listenReservations();
  buildIslandHeader(); renderIslandTable(); renderPlayers(); drawMap();
});

/* Data: islands + CSV */
const islandsRef=collection(db,"islands");
async function loadIslands(){
  const s=await getDocs(islandsRef);
  islands=s.docs.map(d=>d.data()).map(r=>{const o={...r};for(const k in o){if(typeof o[k]==="string")o[k]=o[k].replace(/^"|"$/g,"").trim();}o.Punkte=numberify(o.Punkte);return o;});
}
$("btnCSV").onclick=()=>$("csvInput").click();
$("csvInput").addEventListener("change",async e=>{
  if(currentRole!=="admin")return alert("Nur Admin.");
  const f=e.target.files[0];if(!f)return;$("csvStatus").textContent="Importiere...";
  const txt=await f.text();const lines=txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows=lines.map(l=>l.split(";").map(v=>v.replace(/^"|"$/g,"").trim()));
  const snap=await getDocs(islandsRef);for(const d of snap.docs)await deleteDoc(doc(db,"islands",d.id));
  let i=0;for(const c of rows){const rec={Ozean:c[0]||"",Inselgruppe:c[1]||"",Insel:c[2]||"",Spielername:c[5]||"",AllianzKuerzel:c[7]||"",Punkte:numberify(c[9]||0)};await setDoc(doc(db,"islands",`${i++}`),rec);}
  $("csvStatus").textContent="Fertig.";await loadIslands();buildIslandHeader();renderIslandTable();renderPlayers();drawMap();
});

/* Reservations */
const reservationsRef=collection(db,"reservations");
function listenReservations(){onSnapshot(reservationsRef,s=>{reservations={};s.forEach(d=>reservations[d.id]=d.data());renderIslandTable();});}
window.reserve=async id=>{await setDoc(doc(db,"reservations",id),{user:(await getDoc(doc(db,"users",currentUser.uid))).data().name,status:"requested"});};
window.approve=async id=>{if(currentRole!=="admin")return;await setDoc(doc(db,"reservations",id),{status:"approved"},{merge:true});};
window.deny=async id=>{if(currentRole!=="admin")return;await setDoc(doc(db,"reservations",id),{status:"denied"},{merge:true});};

/* Diplomacy */
async function loadDiplomacy(){allyMap={};playerOverrides={};const a=await getDocs(collection(db,"alliances"));a.forEach(d=>allyMap[d.id]=d.data());const p=await getDocs(collection(db,"playerOverrides"));p.forEach(d=>playerOverrides[d.id]=d.data());renderDiplTables();}
function relationOf(row){const pn=(row.Spielername||"").trim(),ak=(row.AllianzKuerzel||"").trim();if(playerOverrides[pn]?.relation)return playerOverrides[pn].relation; if(ak&&allyMap[ak]?.relation)return allyMap[ak].relation; return ak?"neutral":"neutral";}
$("ally_save").onclick=async()=>{if(currentRole!=="admin")return;const code=$("ally_code").value.trim();if(!code)return alert("K√ºrzel fehlt.");await setDoc(doc(db,"alliances",code),{name:$("ally_name").value.trim(),relation:$("ally_rel").value},{merge:true});await loadDiplomacy();drawMap();};
$("pov_save").onclick=async()=>{if(currentRole!=="admin")return;const pl=$("pov_player").value.trim();if(!pl)return alert("Spieler fehlt.");await setDoc(doc(db,"playerOverrides",pl),{relation:$("pov_rel").value},{merge:true});await loadDiplomacy();drawMap();};
function renderDiplTables(){
  const uniq=new Set(islands.map(r=>r.AllianzKuerzel||"").filter(Boolean));
  const arr=[...uniq].sort((a,b)=>a.localeCompare(b,'de'));$("allyTbody").innerHTML=arr.map(k=>`<tr><td>${k}</td><td>${allyMap[k]?.name||""}</td><td>${allyMap[k]?.relation||"neutral"}</td></tr>`).join("")||`<tr><td colspan="3" class="muted">Keine Eintr√§ge</td></tr>`;
  const pov=Object.keys(playerOverrides).sort((a,b)=>a.localeCompare(b,'de'));$("povTbody").innerHTML=pov.map(p=>`<tr><td>${p}</td><td>${playerOverrides[p].relation}</td></tr>`).join("")||`<tr><td colspan="2" class="muted">Keine Overrides</td></tr>`;
}

/* Insel√ºbersicht (Filter+Sort) */
const headers=[
  {key:"Ozean",label:"Oz",type:"number"},
  {key:"Inselgruppe",label:"IG",type:"number"},
  {key:"Insel",label:"I",type:"number"},
  {key:"Spielername",label:"Spieler",type:"text"},
  {key:"AllianzKuerzel",label:"Allianz",type:"text"},
  {key:"Punkte",label:"Punkte",type:"number"},
  {key:"__reserved_by",label:"Reserviert von",readonly:true},
  {key:"__action",label:"Aktion",readonly:true},
];
const columnFilters={};headers.forEach(h=>columnFilters[h.key]=null);
let sortState={key:null,dir:1};

function buildIslandHeader(){
  const tr=$("theadRow");tr.innerHTML="";
  headers.forEach(h=>{const th=document.createElement("th");th.textContent=h.label;th.dataset.key=h.key;th.onclick=(e)=>{if(!h.readonly)showFilter(h,th);toggleSort(h.key);};tr.appendChild(th);});
  $("btnResetFilters").onclick=()=>{Object.keys(columnFilters).forEach(k=>columnFilters[k]=null);sortState={key:null,dir:1};renderIslandTable();};
}
function toggleSort(k){if(sortState.key===k)sortState.dir*=-1;else sortState={key:k,dir:1};renderIslandTable();}
function renderIslandTable(){
  const rows=islands.map(r=>{const id=`${r.Ozean}-${r.Inselgruppe}-${r.Insel}`,res=reservations[id];return {...r,__reserved_by:res?.user||"",__status:res?.status||"",__resid:id};}).filter(row=>{
    for(const h of headers){const sel=columnFilters[h.key];if(!sel)continue;const v=h.key==="__reserved_by"?row.__reserved_by:(row[h.key]??"");const vs=h.type==="number"?String(numberify(v)):String(v);if(!sel.has(vs))return false;}return true;
  });
  if(sortState.key){const h=headers.find(x=>x.key===sortState.key),k=sortState.key,dir=sortState.dir;rows.sort((a,b)=>{const va=k==="__reserved_by"?a.__reserved_by:(a[k]??""),vb=k==="__reserved_by"?b.__reserved_by:(b[k]??"");return (h?.type==="number"?numberify(va)-numberify(vb):String(va).localeCompare(String(vb),'de',{numeric:true}))*dir;});}
  const tb=$("tbodyRows");tb.innerHTML="";rows.forEach(r=>{const tr=document.createElement("tr");if(r.__status)tr.classList.add(r.__status);
    headers.forEach(h=>{const td=document.createElement("td");td.setAttribute("data-label",h.label);
      if(h.key==="__reserved_by")td.textContent=r.__reserved_by||"-";
      else if(h.key==="__action")td.innerHTML=actionCell(r.__resid,reservations[r.__resid]);
      else if(h.key==="Punkte")td.textContent=numberify(r.Punkte).toLocaleString('de-DE');
      else td.textContent=(r[h.key]??"")||""; tr.appendChild(td);});
    tb.appendChild(tr);
  });
  $("tableStatus").textContent=`${rows.length} von ${islands.length} Eintr√§gen${sortState.key?` ‚Ä¢ Sortiert: ${headers.find(h=>h.key===sortState.key).label} (${sortState.dir===1?'‚Üë':'‚Üì'})`:""}`;
}
function actionCell(id,res){
  if(!currentUser)return"<button disabled>Login n√∂tig</button>";
  if(currentStatus!=="active")return"<button disabled>Ausstehend</button>";
  if(res){
    if(res.status==="requested"&&currentRole==="admin")return `<button class="ok" onclick="approve('${id}')">‚úî</button><button class="ghost" onclick="deny('${id}')">‚úñ</button>`;
    if(res.status==="requested")return"<button disabled>Wartet</button>";
    if(res.status==="approved")return"<button disabled>‚úÖ</button>";
    if(res.status==="denied")return `<button onclick="reserve('${id}')">Reservieren</button>`;
  }
  return `<button onclick="reserve('${id}')">Reservieren</button>`;
}
function showFilter(header,thEl){
  const key=header.key,dd=$("filterDropdown");dd.innerHTML="";dd.classList.remove("hidden");
  const rect=thEl.getBoundingClientRect(),wrap=thEl.closest(".tablewrap").getBoundingClientRect();
  dd.style.left=(rect.left-wrap.left)+"px";dd.style.top=(rect.bottom-wrap.top+4)+"px";
  const vals=new Set(islands.map(r=>String(header.type==="number"?numberify(r[key]??""):(r[key]??""))));
  const items=[...vals].sort((a,b)=>header.type==="number"?(Number(a)-Number(b)):a.localeCompare(b,'de',{numeric:true}));
  const active=columnFilters[key]?new Set(columnFilters[key]):null;
  dd.insertAdjacentHTML("beforeend",`<div class="badge" style="margin-bottom:6px">Filter: ${header.label}</div>`);
  const ctrl=document.createElement("div");ctrl.className="row";
  const btnAll=document.createElement("button");btnAll.className="ghost";btnAll.textContent="Alle an/aus";
  const btnClear=document.createElement("button");btnClear.className="ghost";btnClear.textContent="Leeren";
  ctrl.append(btnAll,btnClear);dd.appendChild(ctrl);
  const list=document.createElement("div");list.className="options";dd.appendChild(list);
  const refs=[];for(const v of items){const row=document.createElement("div");row.className="option-row";const cb=document.createElement("input");cb.type="checkbox";cb.checked=active?active.has(v):true;cb.dataset.val=v;const lab=document.createElement("label");lab.textContent=v===""?"(leer)":(header.type==="number"?Number(v).toLocaleString('de-DE'):v);row.append(cb,lab);list.appendChild(row);refs.push(cb);}
  const actions=document.createElement("div");actions.className="filter-actions";
  const apply=document.createElement("button");apply.textContent="Anwenden";
  const cancel=document.createElement("button");cancel.className="ghost";cancel.textContent="Abbrechen";
  actions.append(apply,cancel);dd.appendChild(actions);
  btnAll.onclick=()=>{const some=refs.some(c=>!c.checked);refs.forEach(c=>c.checked=some);};
  btnClear.onclick=()=>refs.forEach(c=>c.checked=false);
  cancel.onclick=()=>dd.classList.add("hidden");
  apply.onclick=()=>{const sel=refs.filter(c=>c.checked).map(c=>c.dataset.val);columnFilters[key]=(sel.length===items.length||sel.length===0)?null:new Set(sel);dd.classList.add("hidden");renderIslandTable();};
}
document.addEventListener("click",e=>{const dd=$("filterDropdown");if(dd.classList.contains("hidden"))return;if(!dd.contains(e.target)&&!e.target.closest("th"))dd.classList.add("hidden");});

/* Spieler√ºbersicht */
function renderPlayers(){
  const by=new Map();
  islands.forEach(r=>{const p=(r.Spielername||"").trim();const a=(r.AllianzKuerzel||"").trim();if(!p)return;
    if(!by.has(p))by.set(p,{player:p,ally:a,igs:new Set(),count:0,pts:0});
    const o=by.get(p);o.igs.add(String(r.Inselgruppe||""));o.count++;o.pts+=Number(r.Punkte||0);
  });
  const rows=[...by.values()].sort((a,b)=>a.player.localeCompare(b.player,'de'));
  $("playerTbody").innerHTML=rows.map(o=>`<tr><td>${o.player}</td><td>${o.ally||"-"}</td><td>${[...o.igs].filter(Boolean).map(x=>+x||0).sort((a,b)=>a-b).join(", ")||"-"}</td><td>${o.count}</td><td>${o.pts.toLocaleString('de-DE')}</td></tr>`).join("")||`<tr><td colspan="5" class="muted">Keine Daten</td></tr>`;
}

/* Angriff / Verteidigung */
function parseCoordString(s){const p=String(s).replace(/[,;\s-]+/g,":").split(":").map(Number);const oz=Math.max(1,p[0]||1),IG=Math.max(1,p[1]||1),ins=Math.max(1,p[2]||1);const igc=(IG-1)%15,igr=Math.floor((IG-1)/15),inc=(ins-1)%4,inr=Math.floor((ins-1)/4);const oColOff=(oz===1||oz===3)?0:60,oRowOff=(oz===1||oz===2)?0:60;const col=oColOff+igc*4+inc,row=oRowOff+igr*4+inr;return {col,row,oz,IG,ins};}
function distanceTiles(aStr,bStr){const a=parseCoordString(aStr),b=parseCoordString(bStr);const dx=a.col-b.col,dy=a.row-b.row;return Math.sqrt(dx*dx+dy*dy);}
function fmtHHMMSS(sec){const s=Math.max(0,Math.round(sec));const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),x=s%60;return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(x).padStart(2,"0")}`;}
function fmtLocal(d){return d.toLocaleString();}
$("atk_calc").onclick=()=>{
  const from=$("atk_from").value.trim(),to=$("atk_to").value.trim(),t=$("atk_start").value.trim(),unit=$("atk_unit").value,rel=$("atk_relation").value;
  if(!from||!to||!t)return alert("Start/Ziel/Startzeit angeben.");
  const dist=round1(distanceTiles(from,to));const knots=shipKnots[unit];const travelHours=round5(dist/(knots||1));const travelSeconds=Math.round(travelHours*3600);
  const [HH,MM,SS]=t.split(":").map(n=>Number(n)||0);const now=new Date();const start=new Date(now.getFullYear(),now.getMonth(),now.getDate(),HH,MM,SS);const arrive=new Date(start.getTime()+travelSeconds*1000);const back=new Date(arrive.getTime()+travelSeconds*1000);
  const rows = islands.filter(r=>{const pn=(r.Spielername||"").trim(),ak=(r.AllianzKuerzel||"").trim();const rln=playerOverrides[pn]?.relation||(ak?(allyMap[ak]?.relation||"neutral"):"neutral");return rln===rel;})
  .map(r=>{const home=`${r.Ozean}:${r.Inselgruppe}:${r.Insel}`;const d2=round1(distanceTiles(home,to));const h2=round5(d2/(knots||1));const s2=Math.round(h2*3600);const a2=new Date(start.getTime()+s2*1000),b2=new Date(a2.getTime()+s2*1000);return {player:(r.Spielername||"-"),home,unit,dist:d2,secs:s2,arr:a2,ret:b2};})
  .sort((a,b)=>a.secs-b.secs).slice(0,300);
  $("atkTbody").innerHTML=[
    `<tr><td><b>‚Äî</b></td><td>${from}</td><td>${to}</td><td>${unit}</td><td>${dist.toFixed(1)}</td><td>${fmtHHMMSS(travelSeconds)}</td><td>${fmtLocal(arrive)}</td><td>${fmtLocal(back)}</td></tr>`,
    ...rows.map(x=>`<tr><td>${x.player}</td><td>${x.home}</td><td>${to}</td><td>${unit}</td><td>${x.dist.toFixed(1)}</td><td>${fmtHHMMSS(x.secs)}</td><td>${fmtLocal(x.arr)}</td><td>${fmtLocal(x.ret)}</td></tr>`)
  ].join("")||`<tr><td colspan="8" class="muted">Keine Treffer</td></tr>`;
};

/* Map */
const mapCanvas=$("mapCanvas"),ctx=mapCanvas.getContext("2d");$("mapColorMode").onchange=()=>drawMap();
function drawMap(){
  const c=ctx,W=mapCanvas.width,H=mapCanvas.height,cs=getComputedStyle(document.documentElement);
  const bg=cs.getPropertyValue("--map-bg").trim(),gi=cs.getPropertyValue("--grid-i").trim(),gg=cs.getPropertyValue("--grid-ig").trim(),go=cs.getPropertyValue("--grid-o").trim();
  c.clearRect(0,0,W,H);c.fillStyle=bg;c.fillRect(0,0,W,H);
  const TOTAL=120,cell=10,x0=60,y0=60;
  c.strokeStyle=gi;c.lineWidth=0.4;for(let i=0;i<=TOTAL;i++){const p=y0+i*cell;c.beginPath();c.moveTo(x0,p);c.lineTo(x0+TOTAL*cell,p);c.stroke();const q=x0+i*cell;c.beginPath();c.moveTo(q,y0);c.lineTo(q,y0+TOTAL*cell);c.stroke();}
  c.strokeStyle=gg;c.lineWidth=0.8;for(let i=0;i<=TOTAL;i+=4){c.beginPath();c.moveTo(x0,y0+i*cell);c.lineTo(x0+TOTAL*cell,y0+i*cell);c.stroke();c.beginPath();c.moveTo(x0+i*cell,y0);c.lineTo(x0+i*cell,y0+TOTAL*cell);c.stroke();}
  c.strokeStyle=go;c.lineWidth=1.2;c.beginPath();c.moveTo(x0+60*cell,y0);c.lineTo(x0+60*cell,y0+TOTAL*cell);c.moveTo(x0,y0+60*cell);c.lineTo(x0+TOTAL*cell,y0+60*cell);c.stroke();
  const mode=$("mapColorMode").value,txt=cs.getPropertyValue("--text").trim();
  const maxP=Math.max(1,...islands.map(z=>Number(z.Punkte||0)));
  islands.forEach(r=>{
    const oz=+r.Ozean||1,IG=+r.Inselgruppe||1,ins=+r.Insel||1;const igc=(IG-1)%15,igr=Math.floor((IG-1)/15),inc=(ins-1)%4,inr=Math.floor((ins-1)/4);
    const oColOff=(oz===1||oz===3)?0:60,oRowOff=(oz===1||oz===2)?0:60;const col=oColOff+igc*4+inc,row=oRowOff+igr*4+inr,x=x0+col*cell,y=y0+row*cell;
    const name=(r.Spielername||"").trim(),ak=(r.AllianzKuerzel||"").trim(),pts=Number(r.Punkte||0);
    let fill="#9aa3c7"; if(name){ if(!ak){fill=getComputedStyle(document.documentElement).getPropertyValue("--magenta").trim();} else {const rel=relationOf(r);fill=rel==="friendly"?"#3b82f6":rel==="hostile"?"#ef4444":"#6b7280";}}
    if(mode==="points"){const t=Math.min(1,pts/maxP);const v=255-Math.floor(t*160);fill=`rgb(${v},${255-v},200)`;}
    c.fillStyle=fill;c.fillRect(x,y,cell,cell);
    c.fillStyle=txt;c.font=`${Math.max(6,cell*0.9)}px sans-serif`;const lh=Math.max(6,cell*0.9);
    const t1=name?name.slice(0,6):"",t2=ak?ak.slice(0,6):"",t3=pts?String(pts):""; if(cell>=10){c.fillText(t1,x+1,y+lh-1);c.fillText(t2,x+1,y+2*lh-1);c.fillText(t3,x+1,y+3*lh-1);}
  });
  c.fillStyle=txt;c.font="10px sans-serif";for(let i=0;i<225;i++){const igc=i%15,igr=Math.floor(i/15);const cx=x0+igc*4*cell+2*cell,cy=y0+igr*4*cell+2*cell;c.fillText(String(i+1),cx-6,cy+4);}
}

/* Default Tab */
document.querySelector('[data-tab="tab-islands"]').click();
</script>
</body>
</html>