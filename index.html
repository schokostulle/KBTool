<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Allianz Dashboard</title>

<!-- Firebase compat v10 -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --bg:#f9fafb; --card:#fff; --text:#1e293b; --text-muted:#64748b;
  --border:#e2e8f0; --accent:#2563eb; --accent-hover:#1d4ed8;
  --danger:#ef4444; --success:#16a34a; --warn:#facc15; --magenta:#d946ef;
}
[data-theme="dark"] {
  --bg:#0f172a; --card:#1e293b; --text:#e2e8f0; --text-muted:#94a3b8;
  --border:#334155; --accent:#3b82f6; --accent-hover:#60a5fa;
  --danger:#f87171; --success:#22c55e; --warn:#fcd34d; --magenta:#e879f9;
}
*{box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;margin:0;padding:24px;transition:.2s}
h1{margin:0 0 8px}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
.nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
input,button{border-radius:8px;border:1px solid var(--border);background:#fff;color:var(--text);padding:8px 12px}
[data-theme="dark"] input{background:#1e293b;color:var(--text);border-color:var(--border)}
button{background:var(--accent);border:none;color:#fff;cursor:pointer}
button:hover{background:var(--accent-hover)}
button.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
button.ghost:hover{background:var(--accent);color:#fff}
.hidden{display:none}
table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden}
th,td{border-bottom:1px solid var(--border);padding:10px 12px;text-align:left;font-size:14px;white-space:nowrap}
th{background:var(--card);color:var(--text-muted);cursor:pointer;position:relative}
tr.requested{background:rgba(250,204,21,.15)}
tr.approved{background:rgba(22,163,74,.12)}
tr.denied{background:rgba(239,68,68,.12)}
.note{font-size:13px;color:var(--text-muted)}
/* Dropdown-Filter */
.col-filter{position:absolute;min-width:220px;background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:8px;z-index:20}
.options-box{max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:6px;padding:4px}
.option-row{display:flex;align-items:center;gap:6px;font-size:13px;padding:3px 0}
.filter-actions{display:flex;justify-content:flex-end;gap:6px;margin-top:8px}
/* Action-Cell Layout */
.action-cell{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.legend{display:flex;gap:14px;align-items:center;font-size:13px;color:var(--text-muted)}
.legend .swatch{width:12px;height:12px;border-radius:2px;display:inline-block;border:1px solid var(--border)}
</style>
</head>
<body>

<h1>ğŸ Allianz Dashboard</h1>
<button id="themeToggle" class="ghost" style="float:right" onclick="toggleTheme()">ğŸŒ™</button>

<!-- Login -->
<div id="loginView" class="card">
  <h2>Login / Registrierung</h2>
  <div class="nav">
    <input id="username" placeholder="Ingame-Name" />
    <input id="password" type="password" placeholder="Passwort" />
    <button onclick="login()">Anmelden</button>
    <button class="ghost" onclick="register()">Registrieren</button>
  </div>
  <div class="note">Ingame-Name darf nur Buchstaben, Zahlen, Leerzeichen, - und _ enthalten.</div>
</div>

<!-- App -->
<div id="appView" class="hidden">
  <div class="card">
    Angemeldet als <b id="userDisplay">â€“</b> (<span id="roleDisplay">â€“</span>) â€” 
    <span id="statusDisplay" class="note"></span>
    <div class="nav" style="margin-top:8px">
      <button onclick="showPage('tableView')">ğŸ“Š Insel-Tabelle</button>
      <button onclick="showPage('mapView')">ğŸ—º Inselraster</button>
      <button id="adminTab" class="hidden" onclick="showPage('adminView')">âš™ï¸ Mitgliederverwaltung</button>
      <button id="csvTab" class="hidden" onclick="showPage('csvView')">ğŸ“¤ CSV Upload</button>
      <span style="flex:1"></span>
      <button class="ghost" onclick="logout()">ğŸšª Abmelden</button>
    </div>
  </div>

  <!-- Tabelle -->
  <div id="tableView" class="card">
    <div class="nav" style="justify-content:space-between">
      <div class="legend">
        <span><span class="swatch" style="background:rgba(250,204,21,.3)"></span> reserviert</span>
        <span><span class="swatch" style="background:rgba(22,163,74,.3)"></span> bestÃ¤tigt</span>
        <span><span class="swatch" style="background:rgba(239,68,68,.3)"></span> abgelehnt</span>
      </div>
      <button class="ghost" onclick="resetAllFilters()">Filter zurÃ¼cksetzen</button>
    </div>
    <div class="table-wrap" style="position:relative">
      <table id="islandTable"><thead><tr id="tableHeaderRow"></tr></thead><tbody id="tableBody"></tbody></table>
      <div id="filterDropdown" class="col-filter hidden"></div>
    </div>
    <div id="tableStatus" class="note" style="margin-top:8px"></div>
  </div>

  <!-- Inselkarte -->
  <div id="mapView" class="card hidden">
    <div class="nav" style="justify-content:space-between">
      <h3>ğŸ—º Inselraster</h3>
      <div class="legend">
        <span><span class="swatch" style="background:#9aa3c7"></span> kein Spieler</span>
        <span><span class="swatch" style="background:var(--magenta)"></span> keine Allianz</span>
        <span>Farben = Allianzen</span>
      </div>
    </div>
    <canvas id="mapCanvas" width="1200" height="1200" style="border:1px solid var(--border);border-radius:8px;max-width:100%;height:auto;"></canvas>
    <div class="note" style="margin-top:6px">Ozeane: 2Ã—2 (1|2 / 3|4), je Ozean 15Ã—15 IG, je IG 4Ã—4 Inseln â‡’ gesamtes Raster 120Ã—120 Zellen.</div>
  </div>

  <!-- Mitglieder -->
  <div id="adminView" class="card hidden">
    <h3>âš™ï¸ Mitgliederverwaltung</h3>
    <div id="userTable"></div>
    <div class="note" style="margin-top:6px">â€LÃ¶schenâ€œ entfernt nur den Firestore-Datensatz. Auth-Konto in Firebase Console lÃ¶schen.</div>
  </div>

  <!-- CSV Upload -->
  <div id="csvView" class="card hidden">
    <h3>ğŸ“¤ CSV hochladen (nur Admin)</h3>
    <input type="file" id="csvInput" accept=".csv" />
    <button onclick="uploadCSV()">Hochladen & Ersetzen</button>
    <div id="csvStatus" class="note" style="margin-top:6px"></div>
    <div class="note">Erwartet (Semikolon, keine Kopfzeile): Ozean;Inselgruppe;Insel;Inselname;Spieler ID;Spielername;Allianz ID;Allianz KÃ¼rzel;Allianzname;Punkte</div>
  </div>
</div>

<script>
/* ===================== Firebase Setup ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();
const usersRef=db.collection("users"), islandsRef=db.collection("islands"), reservationsRef=db.collection("reservations"), metaRef=db.collection("meta");

/* ===================== State ===================== */
let currentUser=null,currentRole="member",currentStatus="pending";
let csvData=[],reservations={},viewData=[];
const headers=[
  {key:"Ozean",label:"Oz",type:"number"},
  {key:"Inselgruppe",label:"IG",type:"number"},
  {key:"Insel",label:"I",type:"number"},
  {key:"Spielername",label:"Spielername",type:"text"},
  {key:"AllianzKuerzel",label:"AllianzkÃ¼rzel",type:"text"},
  {key:"Punkte",label:"Punkte",type:"number"},
  {key:"__reserved_by",label:"Reserviert von",type:"text",readonly:true},
  {key:"__action",label:"Aktion",type:"text",readonly:true},
];
const columnFilters={};headers.forEach(h=>columnFilters[h.key]=null);
let sortState={key:null,dir:1};

/* ===================== Theme Toggle ===================== */
document.addEventListener("DOMContentLoaded",()=>{
  const pref=localStorage.getItem("theme")||"light";
  document.documentElement.setAttribute("data-theme",pref);
  document.getElementById("themeToggle").textContent=pref==="dark"?"â˜€ï¸":"ğŸŒ™";
});
function toggleTheme(){
  const html=document.documentElement;
  const next=html.getAttribute("data-theme")==="dark"?"light":"dark";
  html.setAttribute("data-theme",next);
  localStorage.setItem("theme",next);
  document.getElementById("themeToggle").textContent=next==="dark"?"â˜€ï¸":"ğŸŒ™";
}

/* ===================== Auth (UID + Meta-Bootstrap, VerzÃ¶gerung + Server-Read) ===================== */
function fakeEmail(name){
  return name.trim().toLowerCase()
    .replace(/[Ã¤]/g,"ae").replace(/[Ã¶]/g,"oe").replace(/[Ã¼]/g,"ue").replace(/[ÃŸ]/g,"ss")
    .replace(/[^\w]+/g,"_")+"@alliancesystem.fake";
}

auth.onAuthStateChanged(async(u)=>{
  if(!u)return;
  await new Promise(r=>setTimeout(r,300)); // kleine VerzÃ¶gerung

  const uid=u.uid;
  const userRef=usersRef.doc(uid);

  let snap=await userRef.get({source:"server"});
  if(!snap.exists){
    // Minimalprofil als pending anlegen
    await userRef.set({uid, ingameName:u.email.split("@")[0].replace(/_/g," "), role:"member", status:"pending", createdAt:new Date()});
    snap=await userRef.get({source:"server"});
  }
  const data=snap.data();

  currentUser={...u, uid, ingameName:data.ingameName || u.email.split("@")[0].replace(/_/g," ")};
  currentRole=data.role||"member";
  currentStatus=data.status||"pending";

  if(currentStatus==="pending"){alert("Dein Account wurde noch nicht freigeschaltet.");await auth.signOut();location.reload();return;}
  if(currentStatus==="blocked"){alert("Dein Account wurde gesperrt.");await auth.signOut();location.reload();return;}

  // UI freigeben
  document.getElementById("loginView").classList.add("hidden");
  document.getElementById("appView").classList.remove("hidden");
  document.getElementById("userDisplay").textContent=currentUser.ingameName;
  document.getElementById("roleDisplay").textContent=currentRole;
  document.getElementById("statusDisplay").textContent="AKTIV";

  if(currentRole==="admin"){document.getElementById("adminTab").classList.remove("hidden");document.getElementById("csvTab").classList.remove("hidden");listenUsers();}
  await loadCSV(); listenReservations(); buildTableHeader(); applyFiltersAndRender();
});

async function login(){
  const n=document.getElementById("username").value.trim(),p=document.getElementById("password").value.trim();
  if(!n||!p)return alert("Bitte Ingame-Name & Passwort angeben!");
  try{await auth.signInWithEmailAndPassword(fakeEmail(n),p);}catch(e){alert(e.message);}
}

async function register() {
  const n = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  if (!n || !p) return alert("Bitte Ingame-Name & Passwort angeben!");
  if (!/^[a-zA-Z0-9 _-]+$/.test(n))
    return alert("UngÃ¼ltiger Ingame-Name. Erlaubt: Buchstaben, Zahlen, Leerzeichen, -, _");

  try {
    // Benutzer anlegen
    await auth.createUserWithEmailAndPassword(fakeEmail(n), p);
    const uid = auth.currentUser.uid;

    // PrÃ¼fe, ob meta/config bereits existiert
    const cfgRef = metaRef.doc("config");
    let firstAdmin = false;
    try {
      // Versuch, Dokument anzulegen â†’ klappt nur einmal
      await cfgRef.create({ adminInitialized: true, createdAt: new Date() });
      firstAdmin = true;
      console.log("ğŸŸ¢ Meta-Dokument neu erstellt â†’ erster Benutzer erkannt.");
    } catch (e) {
      console.log("â„¹ï¸ Meta-Dokument existiert bereits:", e.code);
      firstAdmin = false;
    }

    // Benutzer in Firestore eintragen
    await usersRef.doc(uid).set({
      uid,
      ingameName: n,
      role: firstAdmin ? "admin" : "member",
      status: firstAdmin ? "active" : "pending",
      createdAt: new Date()
    });

    alert(firstAdmin
      ? "Erster Benutzer erkannt. Du bist automatisch Admin und aktiv!"
      : "Registriert. Dein Account wartet auf Freischaltung durch den Admin.");
  } catch (e) {
    console.error("Fehler bei Registrierung:", e);
    alert(e.message);
  }
}

async function logout(){await auth.signOut();location.reload();}

/* ===================== CSV ===================== */
async function uploadCSV() {
  if (currentRole !== "admin") return alert("Nur Admin.");
  const f = document.getElementById("csvInput").files[0];
  if (!f) return alert("Keine CSV gewÃ¤hlt!");
  document.getElementById("csvStatus").textContent = "Wird verarbeitet...";

  const txt = await f.text();
  const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

  // Spalten aufsplitten, AnfÃ¼hrungszeichen entfernen, Zahlen sÃ¤ubern
  const rows = lines.map(line =>
    line.split(";").map(v =>
      v.replace(/^"|"$/g, "").trim()
    )
  );

  const mapped = rows.map(c => ({
    Ozean: c[0] || "",
    Inselgruppe: c[1] || "",
    Insel: c[2] || "",
    Inselname: c[3] || "",
    SpielerID: c[4] || "",
    Spielername: c[5] || "",
    AllianzID: c[6] || "",
    AllianzKuerzel: c[7] || "",
    Allianzname: c[8] || "",
    Punkte: parseInt((c[9] || "0").replace(/\D/g, "")) || 0 // ğŸ”§ hier: Punkte zu Integer
  }));

  // Alte Inseln lÃ¶schen und neue einfÃ¼gen
  const old = await islandsRef.get();
  const b = db.batch();
  old.forEach(d => b.delete(d.ref));
  await b.commit();

  const b2 = db.batch();
  mapped.forEach((r, i) =>
    b2.set(
      islandsRef.doc(`${r.Ozean}-${r.Inselgruppe}-${r.Insel}-${i}`),
      r
    )
  );
  await b2.commit();

  document.getElementById("csvStatus").textContent = "CSV hochgeladen.";
  await loadCSV();
  resetAllFilters();
  applyFiltersAndRender();
}
async function loadCSV(){
  const snap=await islandsRef.get();
  csvData=snap.docs.map(d=>d.data()).map(row=>{
    const out={}; for(const k in row){ out[k]= typeof row[k]==="string"? row[k].replace(/^"|"$/g,"").trim(): row[k]; }
    return out;
  });
  viewData=[...csvData];
}

/* ===================== Reservierungen ===================== */
function listenReservations(){
  reservationsRef.onSnapshot(s=>{
    reservations={}; s.forEach(d=>reservations[d.id]=d.data());
    applyFiltersAndRender();
    if(!document.getElementById("mapView").classList.contains("hidden")) drawMap();
  });
}
async function reserve(key){
  if(currentStatus!=="active") return alert("Dein Account ist nicht aktiv.");
  const doc=await reservationsRef.doc(key).get();
  if(doc.exists && doc.data().status!=="denied") return alert("Bereits reserviert!");
  await reservationsRef.doc(key).set({ islandId:key, reservedBy:currentUser.uid, user:currentUser.ingameName, status:"requested", timestamp:new Date() });
}
async function approve(key){ if(currentRole!=="admin")return; await reservationsRef.doc(key).set({ ...reservations[key], status:"approved" }, { merge:true }); }
async function deny(key){ if(currentRole!=="admin")return; await reservationsRef.doc(key).set({ ...reservations[key], status:"denied" }, { merge:true }); }

/* ===================== Mitgliederverwaltung (UID-basiert) ===================== */
function listenUsers(){
  usersRef.onSnapshot(s=>{
    const users=[]; s.forEach(d=>users.push({id:d.id,...d.data()})); // id = uid
    let html=`<table><thead><tr><th>Name</th><th>Rolle</th><th>Status</th><th>Aktion</th></tr></thead><tbody>`;
    users.forEach(u=>{
      const style = u.status==="pending" ? 'style="background:rgba(250,204,21,.15)"'
                  : u.status==="blocked" ? 'style="background:rgba(239,68,68,.12)"'
                  : 'style="background:rgba(22,163,74,.12)"';
      html+=`<tr ${style}><td>${u.ingameName || u.id}</td><td>${u.role||"member"}</td><td>${u.status||"pending"}</td><td>${renderUserActions(u)}</td></tr>`;
    });
    html+="</tbody></table>";
    document.getElementById("userTable").innerHTML=html;
  });
}
function renderUserActions(u){
  const self = u.id === (currentUser?.uid);
  const dis  = self ? "disabled" : "";
  const roleBtn = u.role==="admin"
    ? `<button class="ghost" ${dis} onclick="setRole('${u.id}','member')">â¬‡ï¸ Mitglied</button>`
    : `<button ${dis} onclick="setRole('${u.id}','admin')">â¬†ï¸ Admin</button>`;
  let statusBtn="";
  if(u.status==="pending") statusBtn=`<button ${dis} onclick="setStatus('${u.id}','active')">Freischalten âœ…</button>`;
  else if(u.status==="active") statusBtn=`<button class="ghost" ${dis} onclick="setStatus('${u.id}','blocked')">Sperren ğŸš«</button>`;
  else if(u.status==="blocked") statusBtn=`<button ${dis} onclick="setStatus('${u.id}','active')">Entsperren ğŸ”“</button>`;
  const delBtn=`<button class="ghost" style="border-color:var(--danger);color:var(--danger)" ${dis} onclick="deleteUserDoc('${u.id}')">ğŸ—‘ LÃ¶schen</button>`;
  return `<div class="action-cell">${roleBtn}${statusBtn}${delBtn}</div>`;
}
async function setRole(uid,role){ await usersRef.doc(uid).set({role},{merge:true}); }
async function setStatus(uid,st){ await usersRef.doc(uid).set({status:st},{merge:true}); }
async function deleteUserDoc(uid){ if(!confirm(`User-Datensatz lÃ¶schen?`))return; await usersRef.doc(uid).delete(); alert("Firestore-Eintrag gelÃ¶scht. Auth-Konto bitte in Firebase Console lÃ¶schen."); }

/* ===================== Tabelle: Filter + Sort ===================== */
function buildTableHeader(){
  const tr=document.getElementById("tableHeaderRow"); tr.innerHTML="";
  headers.forEach(h=>{
    const th=document.createElement("th"); th.textContent=h.label; th.dataset.key=h.key;
    th.onclick=(e)=>{ if(!h.readonly) showColumnFilterDropdown(h, th); setSort(h.key); };
    tr.appendChild(th);
  });
  document.addEventListener("click",(e)=>{
    const dd=document.getElementById("filterDropdown");
    if(dd.classList.contains("hidden"))return;
    if(!dd.contains(e.target) && !e.target.closest("th")) dd.classList.add("hidden");
  });
}
function setSort(key){ if(sortState.key===key)sortState.dir*=-1; else {sortState.key=key; sortState.dir=1;} applyFiltersAndRender(); }
function applyFiltersAndRender(){
  viewData = csvData.filter(row=>{
    const key=`${row.Ozean}-${row.Inselgruppe}-${row.Insel}`;
    const res=reservations[key];
    row.__reserved_by=res?.user||"";
    row.__status=res?.status||"";
    for(const h of headers){
      const sel=columnFilters[h.key]; if(!sel) continue;
      const v=(h.key==="__reserved_by")? row.__reserved_by : (row[h.key]??"").toString();
      if(!sel.has(v)) return false;
    }
    return true;
  });
  if(sortState.key){
    const h=headers.find(x=>x.key===sortState.key); const k=sortState.key, dir=sortState.dir;
    viewData.sort((a,b)=>{
      const va=(k==="__reserved_by")?(a.__reserved_by||""):(a[k]||"");
      const vb=(k==="__reserved_by")?(b.__reserved_by||""):(b[k]||"");
      if(h?.type==="number"){ return ((Number(va)||0)-(Number(vb)||0))*dir; }
      return va.toString().localeCompare(vb.toString(),'de',{numeric:true})*dir;
    });
  }
  renderTableBody();
  const total=csvData.length, shown=viewData.length, filters=Object.values(columnFilters).filter(s=>s&&s.size>0).length;
  document.getElementById("tableStatus").textContent=`${shown} von ${total} EintrÃ¤gen â€¢ Filter: ${filters}` + (sortState.key?` â€¢ Sortiert: ${headers.find(h=>h.key===sortState.key).label} (${sortState.dir===1?'â†‘':'â†“'})`:"");
}
function renderTableBody(){
  const tb=document.getElementById("tableBody"); tb.innerHTML="";
  viewData.forEach(row=>{
    const key=`${row.Ozean}-${row.Inselgruppe}-${row.Insel}`;
    const res=reservations[key];
    const tr=document.createElement("tr"); if(res?.status) tr.classList.add(res.status);
    headers.forEach(h=>{
      const td=document.createElement("td");
      if(h.key==="__reserved_by") td.textContent=res?.user||"-";
      else if(h.key==="__action") td.innerHTML=actionCell(key,res);
      else td.textContent=(row[h.key]??"").toString();
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}
function actionCell(key,res){
  // Layout Ã¼ber .action-cell sichert, dass sich Buttons nicht Ã¼berdecken
  if(!currentUser) return `<div class="action-cell"><button disabled>Login nÃ¶tig</button></div>`;
  if(currentStatus!=="active") return `<div class="action-cell"><button disabled>Gesperrt/Ausstehend</button></div>`;

  // Wenn bereits eine Reservierung existiert â†’ kein "Reservieren"-Button mehr
  if(res){
    if(res.status==="requested"){
      // Admin sieht âœ”ï¸ / âœ–ï¸, auch wenn er selbst reserviert hat
      if(currentRole==="admin"){
        return `<div class="action-cell">
          <span>von ${res.user}</span>
          <button onclick="approve('${key}')">âœ”ï¸</button>
          <button class="ghost" onclick="deny('${key}')">âœ–ï¸</button>
        </div>`;
      }
      // Nicht-Admin
      if(res.reservedBy===currentUser.uid) return `<div class="action-cell"><button disabled>Reserviert (wartet)</button></div>`;
      return `<div class="action-cell"><button disabled>Reserviert von ${res.user}</button></div>`;
    }
    if(res.status==="approved"){
      if(res.reservedBy===currentUser.uid) return `<div class="action-cell"><button disabled>âœ… BestÃ¤tigt</button></div>`;
      return `<div class="action-cell"><button disabled>Reserviert von ${res.user}</button></div>`;
    }
    if(res.status==="denied"){
      // abgelehnt â†’ wieder frei: "Reservieren" anbieten
      return `<div class="action-cell"><button onclick="reserve('${key}')">Reservieren</button></div>`;
    }
  }
  // Keine Reservierung vorhanden â†’ "Reservieren"
  return `<div class="action-cell"><button onclick="reserve('${key}')">Reservieren</button></div>`;
}

/* Dropdown-Filter */
function showColumnFilterDropdown(header, thEl){
  const key=header.key, dd=document.getElementById("filterDropdown");
  dd.innerHTML=""; dd.classList.remove("hidden");
  const rect=thEl.getBoundingClientRect(), wrap=document.querySelector(".table-wrap").getBoundingClientRect();
  dd.style.left=(rect.left-wrap.left)+"px"; dd.style.top=(rect.bottom-wrap.top+4)+"px";

  const values=new Set(csvData.map(r=>(r[key]??"").toString()));
  const active=columnFilters[key]? new Set(columnFilters[key]) : null;

  const title=document.createElement("div"); title.style.fontSize="13px"; title.style.color="var(--text-muted)"; title.textContent=`Filter: ${header.label}`; dd.appendChild(title);
  const ctr=document.createElement("div"); ctr.style.display="flex"; ctr.style.gap="8px"; ctr.style.margin="6px 0";
  const allBtn=document.createElement("button"); allBtn.className="ghost"; allBtn.textContent="Alle an/aus";
  const clrBtn=document.createElement("button"); clrBtn.className="ghost"; clrBtn.textContent="Leeren";
  ctr.appendChild(allBtn); ctr.appendChild(clrBtn); dd.appendChild(ctr);

  const box=document.createElement("div"); box.className="options-box"; dd.appendChild(box);
  const items=Array.from(values).sort((a,b)=> header.type==="number"?((Number(a)||0)-(Number(b)||0)) : a.localeCompare(b,'de',{numeric:true}));
  const refs=[];
  items.forEach(v=>{
    const row=document.createElement("div"); row.className="option-row";
    const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=active?active.has(v):true; chk.dataset.val=v;
    const label=document.createElement("label"); label.textContent=v||"(leer)";
    row.appendChild(chk); row.appendChild(label); box.appendChild(row); refs.push(chk);
  });

  const actions=document.createElement("div"); actions.className="filter-actions";
  const apply=document.createElement("button"); apply.textContent="Anwenden";
  const cancel=document.createElement("button"); cancel.className="ghost"; cancel.textContent="Abbrechen";
  actions.appendChild(apply); actions.appendChild(cancel); dd.appendChild(actions);

  allBtn.onclick=()=>{ const someUnchecked=refs.some(c=>!c.checked); refs.forEach(c=>c.checked=someUnchecked); };
  clrBtn.onclick=()=> refs.forEach(c=>c.checked=false);
  cancel.onclick=()=> dd.classList.add("hidden");
  apply.onclick=()=>{
    const selected=refs.filter(c=>c.checked).map(c=>c.dataset.val);
    if(selected.length===items.length || selected.length===0) columnFilters[key]=null; else columnFilters[key]=new Set(selected);
    dd.classList.add("hidden"); applyFiltersAndRender();
  };
}
function resetAllFilters(){ Object.keys(columnFilters).forEach(k=>columnFilters[k]=null); sortState={key:null,dir:1}; applyFiltersAndRender(); }

/* ===================== Inselraster (quadratisch, 2Ã—2 Ozeane) ===================== */
/*
Ozeane:
  1 | 2
  3 | 4
Je Ozean: 15x15 IG, je IG 4x4 Inseln.
Globale Spalten/Zeilen (0-based):
  oceanColOffset = (oz==1||oz==3) ? 0 : 60
  oceanRowOffset = (oz==1||oz==2) ? 0 : 60
  igCol = (IG-1) % 15, igRow = Math.floor((IG-1)/15)
  insCol = (Insel-1) % 4, insRow = Math.floor((Insel-1)/4)
  col = oceanColOffset + igCol*4 + insCol
  row = oceanRowOffset + igRow*4 + insRow
*/
function drawMap(){
  const canvas=document.getElementById("mapCanvas"), ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const TOTAL = 120; // 120x120 Zellen
  const margin=20;
  const cellSize = Math.floor((canvas.width - 2*margin) / TOTAL);
  const side = Math.max(2, cellSize - 1);
  const border=getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
  const magenta=getComputedStyle(document.documentElement).getPropertyValue('--magenta').trim();

  // Allianz-Farben
  const allianceColor={};
  function hslToHex(h,s,l){ s/=100; l/=100; const k=n=>(n+h/30)%12; const a=s*Math.min(l,1-l);
    const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
    const hx=x=>Math.round(x*255).toString(16).padStart(2,'0'); return `#${hx(f(0))}${hx(f(8))}${hx(f(4))}`;}
  function colorOf(ak){ if(!ak) return "#9aa3c7"; if(allianceColor[ak]) return allianceColor[ak];
    let h=0; for(let i=0;i<ak.length;i++) h=(h*31+ak.charCodeAt(i))>>>0; return (allianceColor[ak]=hslToHex(h%360,60,55)); }

  csvData.forEach(r=>{
    const oz = Math.max(1, Math.min(4, parseInt(r.Ozean)||1));
    const IG = Math.max(1, Math.min(225, parseInt(r.Inselgruppe)||1));
    const ins= Math.max(1, Math.min(16,  parseInt(r.Insel)||1));

    const oceanColOffset = (oz===1 || oz===3) ? 0 : 60;
    const oceanRowOffset = (oz===1 || oz===2) ? 0 : 60;

    const igCol=(IG-1)%15, igRow=Math.floor((IG-1)/15);
    const insCol=(ins-1)%4, insRow=Math.floor((ins-1)/4);

    const col = oceanColOffset + igCol*4 + insCol;
    const row = oceanRowOffset + igRow*4 + insRow;

    const x = margin + col*cellSize;
    const y = margin + row*cellSize;

    const name=(r.Spielername||"").trim();
    const ak=(r.AllianzKuerzel||"").trim();

    let fill = "#9aa3c7"; // kein Spieler
    if(name){
      fill = ak ? colorOf(ak) : magenta; // mit Spieler, aber ggf. ohne Allianz
    }

    ctx.fillStyle=fill; ctx.fillRect(x,y,side,side);
    ctx.strokeStyle=border; ctx.strokeRect(x+0.5,y+0.5,side-1,side-1);
  });

  // Ozean-Trenner (vertikal & horizontal bei 60)
  ctx.strokeStyle=border; ctx.lineWidth=1;
  const xSplit = margin + 60*cellSize - 0.5;
  const ySplit = margin + 60*cellSize - 0.5;
  ctx.beginPath(); ctx.moveTo(xSplit, margin); ctx.lineTo(xSplit, margin + TOTAL*cellSize); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(margin, ySplit); ctx.lineTo(margin + TOTAL*cellSize, ySplit); ctx.stroke();
}

/* ===================== Routing ===================== */
function showPage(id){
  ["tableView","mapView","adminView","csvView"].forEach(v=>document.getElementById(v).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if(id==="mapView") drawMap();
}
</script>
</body>
</html>