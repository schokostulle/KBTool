<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Allianz Dashboard ‚Äì Reservierungen (mit Firebase)</title>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<style>
  :root {
    --bg: #f9fafb;
    --card: #ffffff;
    --border: #e5e7eb;
    --text: #111827;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --shadow: 0 3px 8px rgba(0,0,0,0.08);
    --radius: 10px;
  }

  body { font-family: "Inter", sans-serif; background: var(--bg); color: var(--text); padding: 2rem; }
  h1 { font-size: 1.8rem; margin-bottom: 1rem; }
  button { background: var(--accent); color: white; border: none; border-radius: var(--radius); padding: 6px 10px; cursor: pointer; }
  button:hover { background: var(--accent-hover); }
  .back-btn { background: #6b7280; margin-bottom: 1rem; }
  .back-btn:hover { background: #4b5563; }

  table { border-collapse: collapse; width: 100%; margin-top: 1rem; border-radius: var(--radius); overflow: hidden; }
  th, td { border-bottom: 1px solid var(--border); padding: 8px 10px; font-size: 14px; }
  th { background: #f3f4f6; font-weight: 600; text-align: left; }

  tr.requested { background: #fff7d6; }
  tr.approved  { background: #d1fae5; }
  tr.denied    { background: #fee2e2; }

  .filter-bar { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
  .filter-bar input { padding: 6px 8px; border-radius: var(--radius); border: 1px solid var(--border); }
  .admin-controls button { margin-left: 4px; background: #6b7280; }
  .admin-controls button:hover { background: #4b5563; }
</style>
</head>
<body>

<h1>üèù Inselreservierungen (Firebase)</h1>

<div class="filter-bar">
  <input type="text" id="playerName" placeholder="Dein Spielername" />
  <label><input type="checkbox" id="isAdmin"> Admin-Modus</label>
  <button onclick="resetReservations()">üîÑ Alle l√∂schen (Admin)</button>
</div>

<div id="inselTable"></div>

<script>
  /* ==== üîß Firebase Setup ==== */
  const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const reservationsRef = db.collection("reservations");

  /* ==== Beispiel CSV Datenbasis ==== */
  const csvData = [
    { Ozean:"1", Inselgruppe:"12", Insel:"1", "Spielername":"SpielerA", "Allianzname":"Blau", Punkte:1200 },
    { Ozean:"1", Inselgruppe:"13", Insel:"2", "Spielername":"SpielerB", "Allianzname":"Blau", Punkte:900 },
    { Ozean:"2", Inselgruppe:"21", Insel:"3", "Spielername":"SpielerC", "Allianzname":"Rot", Punkte:1500 },
    { Ozean:"2", Inselgruppe:"22", Insel:"4", "Spielername":"SpielerD", "Allianzname":"Rot", Punkte:700 }
  ];

  // Lokaler Cache
  let reservations = {};

  // Echtzeit-Listener auf Firestore
  reservationsRef.onSnapshot(snapshot => {
    reservations = {};
    snapshot.forEach(doc => reservations[doc.id] = doc.data());
    renderInselTable();
  });

  // Tabelle rendern
  function renderInselTable() {
    const div = document.getElementById("inselTable");
    let html = "<table><thead><tr><th>Oz</th><th>IG</th><th>I</th><th>Spieler</th><th>Allianz</th><th>Punkte</th><th>Reserviert von</th><th>Aktion</th></tr></thead><tbody>";
    csvData.forEach(r => {
      const key = `${r.Ozean}-${r.Inselgruppe}-${r.Insel}`;
      const res = reservations[key];
      let cls = "";
      let reservedBy = res?.user || "";
      if (res?.status === "requested") cls = "requested";
      else if (res?.status === "approved") cls = "approved";
      else if (res?.status === "denied") cls = "denied";

      html += `<tr class="${cls}">
        <td>${r.Ozean}</td>
        <td>${r.Inselgruppe}</td>
        <td>${r.Insel}</td>
        <td>${r.Spielername}</td>
        <td>${r.Allianzname}</td>
        <td>${r.Punkte}</td>
        <td>${reservedBy || "-"}</td>
        <td>${renderActionButton(key, res)}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    div.innerHTML = html;
  }

  // Button-Logik
  function renderActionButton(key, res) {
    const user = document.getElementById("playerName").value.trim();
    const admin = document.getElementById("isAdmin").checked;
    if (!user) return `<button disabled>üîí Name n√∂tig</button>`;

    if (!res || res.status === "denied") {
      return `<button onclick="reserveIsland('${key}','${user}')">Reservieren</button>`;
    }
    if (res.status === "requested") {
      if (res.user === user)
        return `<button disabled>Reserviert (wartet)</button>`;
      if (admin)
        return `<div class='admin-controls'>
          <button onclick="approve('${key}')">‚úîÔ∏è</button>
          <button onclick="deny('${key}')">‚úñÔ∏è</button>
        </div>`;
      return `<button disabled>Reserviert von ${res.user}</button>`;
    }
    if (res.status === "approved") {
      if (res.user === user)
        return `<button disabled>‚úÖ Best√§tigt</button>`;
      return `<button disabled>Reserviert von ${res.user}</button>`;
    }
    return "-";
  }

  // Reservieren
  async function reserveIsland(key, user) {
    const doc = await reservationsRef.doc(key).get();
    if (doc.exists && doc.data().status !== "denied") {
      alert("Diese Insel ist bereits reserviert oder best√§tigt!");
      return;
    }
    await reservationsRef.doc(key).set({ user, status: "requested", timestamp: new Date() });
  }

  // Admin genehmigt
  async function approve(key) {
    await reservationsRef.doc(key).update({ status: "approved" });
  }

  // Admin lehnt ab
  async function deny(key) {
    await reservationsRef.doc(key).update({ status: "denied" });
  }

  // Admin l√∂scht alles
  async function resetReservations() {
    if (!document.getElementById("isAdmin").checked) {
      alert("Nur Admin darf zur√ºcksetzen!");
      return;
    }
    if (!confirm("Alle Reservierungen wirklich l√∂schen?")) return;
    const snapshot = await reservationsRef.get();
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    alert("Alle Reservierungen gel√∂scht.");
  }
</script>
</body>
</html>