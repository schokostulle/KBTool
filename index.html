<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kampftool – Prototyp</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f6f7f9;
    margin: 0;
    padding: 0;
  }
  header {
    background: #1e3a8a;
    color: white;
    padding: 10px 20px;
  }
  h1 { margin: 0; font-size: 20px; }
  section {
    padding: 20px;
  }
  input, button, textarea {
    margin: 5px 0;
    padding: 8px;
  }
  button {
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover { background: #1d4ed8; }
  #main, #hostPanel { display: none; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: white;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
  }
  th { background: #e5e7eb; }
</style>
</head>
<body>
<header>
  <h1>Kampftool – Firebase Version</h1>
</header>

<!-- LOGIN -->
<section id="login">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="E-Mail"><br>
  <input type="password" id="password" placeholder="Passwort"><br>
  <button id="loginBtn">Anmelden</button>
  <button id="registerBtn">Registrieren</button>
  <p id="loginMessage"></p>
</section>

<!-- USER MAIN -->
<section id="main" style="display:none;">
  <h2>Mitgliederbereich</h2>
  <p>Eingeloggt als: <span id="userEmail"></span></p>
  <button id="logoutBtn">Abmelden</button>

  <h3>CSV-Daten (vom Host)</h3>
  <table id="dataTable">
    <thead>
      <tr id="csvHeader"></tr>
    </thead>
    <tbody id="csvBody">
      <tr><td colspan="5">Noch keine Daten vorhanden</td></tr>
    </tbody>
  </table>
</section>

<!-- HOST PANEL -->
<section id="hostPanel" style="display:none;">
  <h2>Host-Bereich</h2>
  <input type="file" id="csvFile" accept=".csv">
  <button id="uploadCsvBtn">CSV hochladen</button>
  <p id="uploadStatus"></p>
</section>

<!-- =============== Firebase SDKs =============== -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// === Firebase Konfiguration einfügen ===
const firebaseConfig = {
  apiKey: "AIzaSyAW5DmnfORhv5oY3azmpNJ4NHniYUGFnsQ",
  authDomain: "ktool-aa787.firebaseapp.com",
  projectId: "ktool-aa787",
  storageBucket: "ktool-aa787.firebasestorage.app",
  messagingSenderId: "528761267115",
  appId: "1:528761267115:web:826f6284db2a2f784d28ee"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ============== LOGIN / REGISTRIERUNG ==============
const loginSection = document.getElementById("login");
const mainSection = document.getElementById("main");
const hostPanel = document.getElementById("hostPanel");
const loginMsg = document.getElementById("loginMessage");

document.getElementById("registerBtn").addEventListener("click", async () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  try {
    await auth.createUserWithEmailAndPassword(email, pass);
    loginMsg.textContent = "Registrierung erfolgreich. Du bist angemeldet.";
  } catch (err) {
    loginMsg.textContent = err.message;
  }
});

document.getElementById("loginBtn").addEventListener("click", async () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch (err) {
    loginMsg.textContent = err.message;
  }
});

document.getElementById("logoutBtn").addEventListener("click", async () => {
  await auth.signOut();
});

// ============== AUTH STATE LISTENER ==============
auth.onAuthStateChanged(user => {
  if (user) {
    loginSection.style.display = "none";
    mainSection.style.display = "block";
    document.getElementById("userEmail").textContent = user.email;

    if (user.email === "schokostulle.777@gmail.com") { // Host-Konto
      hostPanel.style.display = "block";
    } else {
      hostPanel.style.display = "none";
    }

    loadCsvData();
  } else {
    loginSection.style.display = "block";
    mainSection.style.display = "none";
    hostPanel.style.display = "none";
  }
});

// ============== CSV HOCHLADEN (HOST) ==============
document.getElementById("uploadCsvBtn").addEventListener("click", () => {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Bitte CSV-Datei auswählen!");

  Papa.parse(file, {
    header: true,
    dynamicTyping: true,
    complete: async (result) => {
      await db.collection("csvData").doc("latest").set({
        uploaded: new Date(),
        data: result.data
      });
      document.getElementById("uploadStatus").textContent = "CSV erfolgreich gespeichert.";
      loadCsvData();
    }
  });
});

// ============== CSV LADEN UND ANZEIGEN ==============
async function loadCsvData() {
  const docRef = db.collection("csvData").doc("latest");
  const docSnap = await docRef.get();
  if (!docSnap.exists) return;

  const csv = docSnap.data().data;
  if (!csv || csv.length === 0) return;

  const headers = Object.keys(csv[0]);
  document.getElementById("csvHeader").innerHTML = headers.map(h => `<th>${h}</th>`).join("");
  document.getElementById("csvBody").innerHTML = csv.map(row => {
    return `<tr>${headers.map(h => `<td>${row[h] ?? ""}</td>`).join("")}</tr>`;
  }).join("");
}
</script>
</body>
</html>