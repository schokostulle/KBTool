<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Allianz-Kampfberichte</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea { width: 100%; height: 120px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    .hidden { display: none; }
    input { margin-bottom: 5px; display: block; }
    button { margin-bottom: 10px; }
  </style>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Allianz-Kampfberichte</h1>

<!-- Authentifizierung -->
<div id="authDiv">
  <h3>Registrieren</h3>
  <input type="email" id="regEmail" placeholder="Email">
  <input type="password" id="regPass" placeholder="Passwort">
  <button id="registerBtn">Registrieren</button>

  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPass" placeholder="Passwort">
  <button id="loginBtn">Login</button>
</div>

<!-- Kampfberichte -->
<div id="reportDiv" class="hidden">
  <h3>Kampfbericht einfügen</h3>
  <textarea id="reportText" placeholder="Kampfbericht hier einfügen"></textarea>
  <button id="submitReportBtn">Absenden</button>

  <h3>Alle Berichte</h3>
  <div id="reportsTable"></div>

  <h3>Aggregierte Übersicht</h3>
  <table id="aggregateTable">
    <thead>
      <tr>
        <th>Einheit/Gebäude/Rohstoff</th>
        <th>Anzahl / Level</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="logoutBtn">Logout</button>
</div>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const authDiv = document.getElementById("authDiv");
  const reportDiv = document.getElementById("reportDiv");

  // ===== Registrierung =====
  document.getElementById("registerBtn").addEventListener("click", async () => {
    const email = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPass").value;
    try { await auth.createUserWithEmailAndPassword(email, pass); alert("Registrierung erfolgreich!"); }
    catch (e) { alert(e.message); }
  });

  // ===== Login =====
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("loginEmail").value;
    const pass = document.getElementById("loginPass").value;
    try { await auth.signInWithEmailAndPassword(email, pass); }
    catch (e) { alert(e.message); }
  });

  // ===== Logout =====
  document.getElementById("logoutBtn").addEventListener("click", () => { auth.signOut(); });

  // ===== Auth State Listener =====
  auth.onAuthStateChanged(user => {
    if (user) {
      authDiv.classList.add("hidden");
      reportDiv.classList.remove("hidden");
      renderAggregated();
    } else {
      authDiv.classList.remove("hidden");
      reportDiv.classList.add("hidden");
    }
  });

  // ===== Kampfbericht absenden =====
  document.getElementById("submitReportBtn").addEventListener("click", async () => {
    const text = document.getElementById("reportText").value;
    const user = auth.currentUser;
    if (!user) return alert("Bitte einloggen!");
    if (!text.trim()) return alert("Bericht darf nicht leer sein!");
    await db.collection("reports").add({ userId: user.uid, text, date: new Date() });
    document.getElementById("reportText").value = "";
    renderAggregated();
  });

  // ===== Parsing-Funktion =====
  function parseReport(text) {
    const lines = text.split("\n");
    const data = { attacker: {}, defender: {}, buildings: {}, plunder: {} };
    let currentBlock = null;

    lines.forEach(line => {
      line = line.trim();
      if (!line) return;

      if (line.startsWith("Einheiten des Angreifers")) { currentBlock = "attacker"; return; }
      if (line.startsWith("Einheiten des Verteidigers")) { currentBlock = "defender"; return; }
      if (line.startsWith("Zerstörung") || line.startsWith("Kollateralschaden")) { currentBlock = "buildings"; return; }
      if (line.startsWith("Geplünderte Rohstoffe")) { currentBlock = "plunder"; return; }

      if (currentBlock === "attacker" || currentBlock === "defender") {
        const match = line.match(/(\w+)\s+(\d+)\s+(\d+)/);
        if (match) {
          const unit = match[1];
          const total = parseInt(match[2]);
          const losses = parseInt(match[3]);
          data[currentBlock][unit] = { total, losses };
        }
      }

      if (currentBlock === "buildings") {
        const match = line.match(/(\w+)\s*\((\d+) auf (\d+)\)/);
        if (match) {
          const building = match[1];
          const after = parseInt(match[3]);
          data.buildings[building] = after;
        }
      }

      if (currentBlock === "plunder") {
        const match = line.match(/(\w+)\s+(\d+)/);
        if (match) {
          const resource = match[1];
          const amount = parseInt(match[2]);
          data.plunder[resource] = amount;
        }
      }
    });

    return data;
  }

  // ===== Aggregation & Anzeige =====
  async function renderAggregated() {
    const snapshot = await db.collection("reports").orderBy("date").get();
    const reportsTable = document.getElementById("reportsTable");
    const tbody = document.querySelector("#aggregateTable tbody");
    reportsTable.innerHTML = "";
    tbody.innerHTML = "";

    const aggregate = { units: {}, buildings: {}, plunder: {} };

    snapshot.docs.forEach(doc => {
      const data = parseReport(doc.data().text);
      reportsTable.innerHTML += `<p><strong>${doc.data().date.toDate().toLocaleString()}</strong>: ${doc.data().text}</p>`;

      ["attacker","defender"].forEach(side => {
        for (const [unit, info] of Object.entries(data[side])) {
          aggregate.units[unit] = (aggregate.units[unit] || 0) + (info.total - info.losses);
        }
      });

      for (const [building, level] of Object.entries(data.buildings)) {
        aggregate.buildings[building] = Math.max(aggregate.buildings[building] || 0, level);
      }

      for (const [res, amount] of Object.entries(data.plunder)) {
        aggregate.plunder[res] = (aggregate.plunder[res] || 0) + amount;
      }
    });

    for (const [unit, count] of Object.entries(aggregate.units)) {
      tbody.innerHTML += `<tr><td>${unit}</td><td>${count}</td></tr>`;
    }
    for (const [building, level] of Object.entries(aggregate.buildings)) {
      tbody.innerHTML += `<tr><td>${building}</td><td>${level}</td></tr>`;
    }
    for (const [res, amount] of Object.entries(aggregate.plunder)) {
      tbody.innerHTML += `<tr><td>${res}</td><td>${amount}</td></tr>`;
    }
  }
</script>

</body>
</html>