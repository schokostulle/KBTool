<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Allianz-Kampfberichte Tool</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    .hidden { display: none; }
    button { margin-bottom: 10px; }
  </style>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Allianz-Kampfberichte</h1>

<!-- Auth -->
<div id="authDiv">
  <h3>Registrieren</h3>
  <input type="email" id="regEmail" placeholder="Email">
  <input type="password" id="regPass" placeholder="Passwort">
  <button id="registerBtn">Registrieren</button>

  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPass" placeholder="Passwort">
  <button id="loginBtn">Login</button>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden">
  <h3>CSV hochladen (Inseln / Spieler)</h3>
  <input type="file" id="csvUpload" accept=".csv">
  <button id="uploadCsvBtn">CSV hochladen</button>

  <h3>Mitglieder freischalten</h3>
  <div id="membersList"></div>
  <button id="refreshMembersBtn">Liste aktualisieren</button>

  <button id="logoutBtnAdmin">Logout</button>
</div>

<!-- Mitglieder Panel -->
<div id="memberPanel" class="hidden">
  <h3>Kampfbericht einfügen</h3>
  <textarea id="reportText" placeholder="Kampfbericht hier einfügen"></textarea>
  <button id="submitReportBtn">Absenden</button>

  <h3>Alle Berichte der Allianz (neueste zuerst)</h3>
  <div id="reportsTable"></div>

  <h3>Aggregierte Übersicht</h3>
  <table id="aggregateTable">
    <thead>
      <tr>
        <th>Einheit/Gebäude/Rohstoff</th>
        <th>Anzahl / Level</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="logoutBtnMember">Logout</button>
</div>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const authDiv = document.getElementById("authDiv");
  const adminPanel = document.getElementById("adminPanel");
  const memberPanel = document.getElementById("memberPanel");

  // ===== Registrierung =====
  document.getElementById("registerBtn").addEventListener("click", async () => {
    const email = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPass").value;
    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
      // Standard: member, nicht freigeschaltet
      await db.collection("users").doc(userCredential.user.uid).set({
        email,
        role: "member",
        allianceId: null,
        approved: false
      });
      alert("Registrierung erfolgreich! Bitte auf Freischaltung warten.");
    } catch(e){ alert(e.message); }
  });

  // ===== Login =====
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("loginEmail").value;
    const pass = document.getElementById("loginPass").value;
    try { await auth.signInWithEmailAndPassword(email, pass); }
    catch(e){ alert(e.message); }
  });

  // ===== Logout =====
  document.getElementById("logoutBtnAdmin").addEventListener("click", () => auth.signOut());
  document.getElementById("logoutBtnMember").addEventListener("click", () => auth.signOut());

  // ===== Auth State =====
  auth.onAuthStateChanged(async user => {
    if(!user){ authDiv.classList.remove("hidden"); adminPanel.classList.add("hidden"); memberPanel.classList.add("hidden"); return; }
    const userDoc = await db.collection("users").doc(user.uid).get();
    const data = userDoc.data();
    authDiv.classList.add("hidden");

    if(data.role === "admin"){
      adminPanel.classList.remove("hidden");
      memberPanel.classList.add("hidden");
      loadMembers();
    } else if(data.role === "member" && data.approved){
      memberPanel.classList.remove("hidden");
      adminPanel.classList.add("hidden");
      renderAggregated();
    } else {
      alert("Mitglied noch nicht freigeschaltet.");
      auth.signOut();
    }
  });

  // ===== CSV Upload (Admin) =====
  document.getElementById("uploadCsvBtn").addEventListener("click", () => {
    const file = document.getElementById("csvUpload").files[0];
    if(!file) return alert("Bitte CSV wählen!");
    const reader = new FileReader();
    reader.onload = async e => {
      const text = e.target.result;
      const lines = text.split("\n");
      const header = lines.shift().split(/\t/);
      const batch = db.batch();
      lines.forEach(line => {
        const values = line.split(/\t/);
        if(values.length !== header.length) return;
        const player = {};
        header.forEach((key,i) => { player[key.trim()] = values[i].trim(); });
        const docRef = db.collection("players").doc(player["Spieler ID"]);
        batch.set(docRef, player);
      });
      await batch.commit();
      alert("CSV erfolgreich hochgeladen!");
    };
    reader.readAsText(file);
  });

  // ===== Mitglieder freischalten (Admin) =====
  async function loadMembers(){
    const snapshot = await db.collection("users").where("role","==","member").get();
    const div = document.getElementById("membersList");
    div.innerHTML = "";
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      const btn = document.createElement("button");
      btn.textContent = data.approved ? `✅ ${data.email}` : `❌ ${data.email} freischalten`;
      btn.disabled = data.approved;
      btn.onclick = async () => {
        await db.collection("users").doc(doc.id).update({approved:true});
        loadMembers();
      };
      div.appendChild(btn);
      div.appendChild(document.createElement("br"));
    });
  }
  document.getElementById("refreshMembersBtn").addEventListener("click", loadMembers);

  // ===== Kampfberichte einfügen =====
  document.getElementById("submitReportBtn").addEventListener("click", async () => {
    const text = document.getElementById("reportText").value;
    const user = auth.currentUser;
    if(!user) return alert("Bitte einloggen!");
    if(!text.trim()) return alert("Bericht leer!");
    const userDoc = await db.collection("users").doc(user.uid).get();
    await db.collection("reports").add({
      userId: user.uid,
      allianceId: userDoc.data().allianceId,
      reportText: text,
      date: new Date()
    });
    document.getElementById("reportText").value = "";
    renderAggregated();
  });

  // ===== Parsing Funktion (einfaches Beispiel) =====
  function parseReport(text){
    const lines = text.split("\n");
    const data = { units:{}, buildings:{}, plunder:{} };
    lines.forEach(line => {
      const match = line.match(/(\w+)\s+(\d+)/);
      if(match){
        const key = match[1];
        const value = parseInt(match[2]);
        data.units[key] = (data.units[key]||0)+value;
      }
    });
    return data;
  }

  // ===== Aggregation und Anzeige =====
  async function renderAggregated(){
    const user = auth.currentUser;
    const userDoc = await db.collection("users").doc(user.uid).get();
    const allianceId = userDoc.data().allianceId;
    const snapshot = await db.collection("reports")
      .where("allianceId","==",allianceId)
      .orderBy("date","desc").get();

    const reportsDiv = document.getElementById("reportsTable");
    const tbody = document.querySelector("#aggregateTable tbody");
    reportsDiv.innerHTML = "";
    tbody.innerHTML = "";
    const aggregate = { units:{}, buildings:{}, plunder:{} };

    snapshot.docs.forEach(doc => {
      const r = doc.data();
      reportsDiv.innerHTML += `<p><strong>${r.date.toDate().toLocaleString()}</strong>: ${r.reportText}</p>`;
      const parsed = parseReport(r.reportText);
      Object.entries(parsed.units).forEach(([k,v]) => aggregate.units[k]=(aggregate.units[k]||0)+v);
    });

    Object.entries(aggregate.units).forEach(([k,v])=>{
      tbody.innerHTML += `<tr><td>${k}</td><td>${v}</td></tr>`;
    });
  }

</script>

</body>
</html>