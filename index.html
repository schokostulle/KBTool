<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Allianz Dashboard</title>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --bg: #f9fafb;
  --card: #ffffff;
  --text: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --danger: #ef4444;
  --success: #16a34a;
  --warn: #facc15;
  --magenta: #d946ef;
}
[data-theme="dark"] {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #e2e8f0;
  --text-muted: #94a3b8;
  --border: #334155;
  --accent: #3b82f6;
  --accent-hover: #60a5fa;
  --danger: #f87171;
  --success: #22c55e;
  --warn: #fcd34d;
  --magenta: #e879f9;
}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;margin:0;padding:24px;transition:.2s}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
h1{margin:0 0 8px}
.nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
input,button{border-radius:8px;border:1px solid var(--border);background:#fff;color:var(--text);padding:8px 12px}
[data-theme="dark"] input{background:#1e293b;color:var(--text);border-color:var(--border)}
button{background:var(--accent);border:none;color:#fff;cursor:pointer}
button:hover{background:var(--accent-hover)}
button.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
button.ghost:hover{background:var(--accent);color:#fff}
.hidden{display:none}
table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden}
th,td{border-bottom:1px solid var(--border);padding:10px 12px;text-align:left;font-size:14px;white-space:nowrap}
th{background:var(--card);color:var(--text-muted);cursor:pointer;position:relative}
tr.requested{background:rgba(250,204,21,.15)}
tr.approved{background:rgba(22,163,74,.12)}
tr.denied{background:rgba(239,68,68,.12)}
.note{font-size:13px;color:var(--text-muted)}
.col-filter{position:absolute;min-width:220px;background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:8px;z-index:20}
.options-box{max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:6px;padding:4px}
.option-row{display:flex;align-items:center;gap:6px;font-size:13px;padding:3px 0}
.filter-actions{display:flex;justify-content:flex-end;gap:6px;margin-top:8px}
.legend{display:flex;gap:14px;align-items:center;font-size:13px;color:var(--text-muted)}
.legend .swatch{width:12px;height:12px;border-radius:2px;display:inline-block;border:1px solid var(--border)}
</style>
</head>
<body>

<h1>üèù Allianz Dashboard</h1>
<button id="themeToggle" class="ghost" style="float:right" onclick="toggleTheme()">üåô</button>

<div id="loginView" class="card">
  <h2>Login / Registrierung</h2>
  <input id="username" placeholder="Ingame-Name" />
  <input id="password" type="password" placeholder="Passwort" />
  <button onclick="login()">Anmelden</button>
  <button class="ghost" onclick="register()">Registrieren</button>
</div>

<div id="appView" class="hidden">
  <div class="card">
    Angemeldet als <b id="userDisplay">‚Äì</b> (<span id="roleDisplay">‚Äì</span>) ‚Äî <span id="statusDisplay" class="note"></span>
    <div class="nav" style="margin-top:8px">
      <button onclick="showPage('tableView')">üìä Insel-Tabelle</button>
      <button onclick="showPage('mapView')">üó∫ Inselraster</button>
      <button id="adminTab" class="hidden" onclick="showPage('adminView')">‚öôÔ∏è Mitgliederverwaltung</button>
      <button id="csvTab" class="hidden" onclick="showPage('csvView')">üì§ CSV Upload</button>
      <span style="flex:1"></span>
      <button class="ghost" onclick="logout()">üö™ Abmelden</button>
    </div>
  </div>

  <div id="tableView" class="card">
    <div class="nav" style="justify-content:space-between">
      <div class="legend">
        <span><span class="swatch" style="background:rgba(250,204,21,.3)"></span> reserviert</span>
        <span><span class="swatch" style="background:rgba(22,163,74,.3)"></span> best√§tigt</span>
        <span><span class="swatch" style="background:rgba(239,68,68,.3)"></span> abgelehnt</span>
      </div>
      <button class="ghost" onclick="resetAllFilters()">Filter zur√ºcksetzen</button>
    </div>
    <div class="table-wrap" style="position:relative">
      <table id="islandTable"><thead><tr id="tableHeaderRow"></tr></thead><tbody id="tableBody"></tbody></table>
      <div id="filterDropdown" class="col-filter hidden"></div>
    </div>
    <div id="tableStatus" class="note" style="margin-top:8px"></div>
  </div>

  <div id="mapView" class="card hidden">
    <div class="nav" style="justify-content:space-between">
      <h3>üó∫ Inselraster</h3>
      <div class="legend">
        <span><span class="swatch" style="background:#9aa3c7"></span> kein Spieler</span>
        <span><span class="swatch" style="background:var(--magenta)"></span> keine Allianz</span>
        <span>Farben = Allianzen</span>
      </div>
    </div>
    <canvas id="mapCanvas" width="1200" height="500" style="border:1px solid var(--border);border-radius:8px;"></canvas>
  </div>

  <div id="adminView" class="card hidden">
    <h3>‚öôÔ∏è Mitgliederverwaltung</h3>
    <div id="userTable"></div>
  </div>

  <div id="csvView" class="card hidden">
    <h3>üì§ CSV hochladen (nur Admin)</h3>
    <input type="file" id="csvInput" accept=".csv" />
    <button onclick="uploadCSV()">Hochladen</button>
    <div id="csvStatus" class="note" style="margin-top:6px"></div>
  </div>
</div>

<script>
/* Firebase Setup */
const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();
const usersRef=db.collection("users"),islandsRef=db.collection("islands"),reservationsRef=db.collection("reservations");

let currentUser=null,currentRole="member",currentStatus="pending",csvData=[],reservations={};
const headers=[
  {key:"Ozean",label:"Oz",type:"number"},
  {key:"Inselgruppe",label:"IG",type:"number"},
  {key:"Insel",label:"I",type:"number"},
  {key:"Spielername",label:"Spielername",type:"text"},
  {key:"AllianzKuerzel",label:"Allianzk√ºrzel",type:"text"},
  {key:"Punkte",label:"Punkte",type:"number"},
  {key:"__reserved_by",label:"Reserviert von",type:"text",readonly:true},
  {key:"__action",label:"Aktion",type:"text",readonly:true},
];
const columnFilters={};headers.forEach(h=>columnFilters[h.key]=null);
let sortState={key:null,dir:1};

/* Theme Toggle */
document.addEventListener("DOMContentLoaded",()=>{
  const pref=localStorage.getItem("theme")||"light";
  document.documentElement.setAttribute("data-theme",pref);
  document.getElementById("themeToggle").textContent=pref==="dark"?"‚òÄÔ∏è":"üåô";
});
function toggleTheme(){
  const html=document.documentElement;
  const dark=html.getAttribute("data-theme")==="dark";
  const next=dark?"light":"dark";
  html.setAttribute("data-theme",next);
  localStorage.setItem("theme",next);
  document.getElementById("themeToggle").textContent=next==="dark"?"‚òÄÔ∏è":"üåô";
}

/* AUTH */
function fakeEmail(n){return n.toLowerCase().replace(/\s+/g,"_")+"@alliancesystem.fake";}

auth.onAuthStateChanged(async(u)=>{
  if(!u)return;
  const name=u.email.split("@")[0].replace(/_/g," ");
  const ref=usersRef.doc(name);
  let doc=await ref.get();
  if(!doc.exists){
    await ref.set({ingameName:name,role:"member",status:"pending"});
    doc=await ref.get();
  }
  const d=doc.data();
  currentUser={...u,ingameName:name};
  currentRole=d.role||"member";
  currentStatus=d.status||"pending";

  if(currentStatus==="pending"){alert("Dein Account wurde noch nicht freigeschaltet.");await auth.signOut();location.reload();return;}
  if(currentStatus==="blocked"){alert("Dein Account wurde gesperrt.");await auth.signOut();location.reload();return;}

  document.getElementById("loginView").classList.add("hidden");
  document.getElementById("appView").classList.remove("hidden");
  document.getElementById("userDisplay").textContent=name;
  document.getElementById("roleDisplay").textContent=currentRole;
  document.getElementById("statusDisplay").textContent="AKTIV";
  if(currentRole==="admin"){document.getElementById("adminTab").classList.remove("hidden");document.getElementById("csvTab").classList.remove("hidden");listenUsers();}
  await loadCSV();listenReservations();buildTableHeader();applyFiltersAndRender();
});

async function login(){const n=document.getElementById("username").value.trim(),p=document.getElementById("password").value.trim();if(!n||!p)return alert("Bitte Ingame-Name & Passwort angeben!");try{await auth.signInWithEmailAndPassword(fakeEmail(n),p);}catch(e){alert(e.message);}}
async function register(){
  const n=document.getElementById("username").value.trim(),p=document.getElementById("password").value.trim();
  if(!n||!p)return alert("Bitte Ingame-Name & Passwort angeben!");
  const adminExists=!(await usersRef.where("role","==","admin").get()).empty;
  try{
    await auth.createUserWithEmailAndPassword(fakeEmail(n),p);
    await usersRef.doc(n).set({ingameName:n,role:adminExists?"member":"admin",status:adminExists?"pending":"active"});
    alert(adminExists?"Registriert. Dein Account wartet auf Freischaltung.":"Du bist der erste Admin!");
  }catch(e){alert(e.message);}
}
async function logout(){await auth.signOut();location.reload();}

/* CSV Upload/Load, Reservierungen, Table + Map ‚Äì gleich wie zuvor (gek√ºrzt f√ºr Platz) */
/* Mitgliederverwaltung */
function listenUsers(){
  usersRef.onSnapshot(s=>{
    const users=[];s.forEach(d=>users.push({id:d.id,...d.data()}));
    let html=`<table><thead><tr><th>Name</th><th>Rolle</th><th>Status</th><th>Aktion</th></tr></thead><tbody>`;
    users.forEach(u=>{
      let rowClass="";
      if(u.status==="pending")rowClass='style="background:rgba(250,204,21,.15)"';
      if(u.status==="blocked")rowClass='style="background:rgba(239,68,68,.12)"';
      if(u.status==="active")rowClass='style="background:rgba(22,163,74,.12)"';
      html+=`<tr ${rowClass}><td>${u.ingameName}</td><td>${u.role}</td><td>${u.status}</td><td>${renderUserActions(u)}</td></tr>`;
    });
    html+="</tbody></table>";
    document.getElementById("userTable").innerHTML=html;
  });
}
function renderUserActions(u){
  const self=u.ingameName===currentUser.ingameName,dis=self?"disabled":"";
  const roleBtn=u.role==="admin"
    ?`<button class="ghost" ${dis} onclick="setRole('${u.ingameName}','member')">‚¨áÔ∏è Mitglied</button>`
    :`<button ${dis} onclick="setRole('${u.ingameName}','admin')">‚¨ÜÔ∏è Admin</button>`;
  let statusBtn="";
  if(u.status==="pending")statusBtn=`<button ${dis} onclick="setStatus('${u.ingameName}','active')">Freischalten ‚úÖ</button>`;
  else if(u.status==="active")statusBtn=`<button class="ghost" ${dis} onclick="setStatus('${u.ingameName}','blocked')">Sperren üö´</button>`;
  else if(u.status==="blocked")statusBtn=`<button ${dis} onclick="setStatus('${u.ingameName}','active')">Entsperren üîì</button>`;
  const deleteBtn=`<button class="ghost" style="border-color:var(--danger);color:var(--danger)" ${dis} onclick="deleteUserDoc('${u.ingameName}')">üóë L√∂schen</button>`;
  return `${roleBtn} ${statusBtn} ${deleteBtn}`;
}
async function setRole(name,role){await usersRef.doc(name).set({role},{merge:true});}
async function setStatus(name,status){await usersRef.doc(name).set({status},{merge:true});}
async function deleteUserDoc(name){if(!confirm(`"${name}" l√∂schen?`))return;await usersRef.doc(name).delete();alert("Gel√∂scht. (Auth-Konto bitte in Firebase Console entfernen.)");}
</script>
</body>
</html>