<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Allianz-Dashboard</title>

<style>
/* ===================================== */
/*        Harmonisches Farbschema        */
/* ===================================== */
:root {
  /* üåô Dark Mode */
  --bg:#0d1117;
  --card:#161b22;
  --text:#e6edf3;
  --muted:#8b949e;
  --border:#30363d;
  --accent:#60a5fa;
  --accent-2:#3b82f6;
  --ok:#22c55e;
  --warn:#fbbf24;
  --danger:#ef4444;
  --magenta:#e879f9;
  --map-bg:#0b1220;
  --map-grid-light:#6b7280;
  --map-grid-dark:#3f3f46;
  --map-ocean:rgba(255,70,70,0.8);
}
:root.light {
  /* ‚òÄÔ∏è Light Mode */
  --bg:#f9fafb;
  --card:#ffffff;
  --text:#111827;
  --muted:#374151;
  --border:#d1d5db;
  --accent:#3b82f6;
  --accent-2:#2563eb;
  --ok:#16a34a;
  --warn:#d97706;
  --danger:#dc2626;
  --magenta:#db2777;
  --map-bg:#f3f4f6;
  --map-grid-light:#d1d5db;
  --map-grid-dark:#9ca3af;
  --map-ocean:rgba(239,68,68,0.4);
}

/* ===================================== */
/*              Basis Layout             */
/* ===================================== */
*{box-sizing:border-box;}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:Inter,system-ui,sans-serif;
  transition:background .3s,color .3s;
}
h1,h2,h3{margin:0}
.hidden{display:none}

.header{
  position:sticky;top:0;z-index:100;
  background:var(--card);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px;padding:10px 16px;
}
.header .spacer{flex:1}

.container{max-width:1200px;margin:0 auto;padding:16px}
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.2);
  padding:16px;margin-top:16px;
}

button,input{
  border-radius:10px;border:1px solid var(--border);
  background:var(--card);color:var(--text);
  padding:10px 12px;font-size:14px;transition:background .2s,color .2s,border .2s;
}
button{background:var(--accent);border-color:transparent;cursor:pointer;}
button:hover{background:var(--accent-2);}
button.ghost{background:transparent;border:1px solid var(--border);}
button.ghost:hover{background:var(--card);}
button.ok{background:var(--ok);}
button.warn{background:var(--warn);}
button.danger{background:var(--danger);}

.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.spacer{flex:1;}
.badge{color:var(--muted);font-size:13px;}
.sep{height:1px;background:var(--border);margin:10px 0;}
.tabbar{display:flex;gap:8px;margin-top:8px;}
.tabcontent{margin-top:12px;}

/* ===================================== */
/*              Inselkarte               */
/* ===================================== */
#mapCanvas{
  display:block;
  width:100%;
  max-width:100%;
  height:auto;
  background:var(--map-bg);
  border:1px solid var(--border);
  border-radius:12px;
  margin:auto;
}
.legend{display:flex;gap:16px;align-items:center;color:var(--muted);font-size:13px;}
.sw{width:12px;height:12px;border:1px solid var(--border);border-radius:2px;display:inline-block;}

/* ===================================== */
/*             Tabellenlayout            */
/* ===================================== */
.tablewrap{position:relative;overflow:auto;border-radius:10px;border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap;}
th{position:sticky;top:0;background:var(--card);color:var(--muted);cursor:pointer;}
tr.requested{background:rgba(251,191,36,.12);}
tr.approved{background:rgba(34,197,94,.12);}
tr.denied{background:rgba(239,68,68,.12);}

/* Dropdown-Filter */
.col-filter{position:absolute;min-width:240px;background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.4);padding:8px;z-index:40;}
.col-filter .options{max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:4px;}
.option-row{display:flex;gap:6px;align-items:center;font-size:13px;padding:4px 6px;}
.filter-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px;}

/* ===================================== */
/*            Responsive Tables          */
/* ===================================== */
@media (max-width: 900px){
  table,thead,tbody,th,td,tr{display:block;width:100%;}
  th{position:relative;top:0;}
  tr{border-bottom:1px solid var(--border);margin-bottom:8px;padding:6px 0;}
  td{display:flex;justify-content:space-between;padding:6px 10px;}
  td::before{content:attr(data-label);font-weight:600;color:var(--muted);}
  th,#theadRow{display:none;}
}
</style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div><b>üèù Allianz-Dashboard</b></div>
    <div class="spacer"></div>
    <button id="btnTheme" class="ghost">üåô Dark</button>
  </div>

  <div class="container">

    <!-- LOGIN -->
    <div id="loginView" class="card">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h2>Login / Registrierung</h2>
      </div>
      <div class="sep"></div>
      <div class="row" style="gap:12px;">
        <input id="username" placeholder="Ingame-Name (z.B. Max)" style="flex:1;min-width:220px;">
        <input id="password" type="password" placeholder="Passwort" style="flex:1;min-width:220px;">
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="btnLogin">Anmelden</button>
        <button id="btnRegister" class="ghost">Registrieren</button>
        <span class="badge">Der erste registrierte Account wird automatisch als Admin aktiviert.</span>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="hidden">
      <div class="card">
        <div class="row">
          <div>üë§ <b id="userDisplay">‚Äì</b> ‚Ä¢ Rolle: <b id="roleDisplay">‚Äì</b> ‚Ä¢ Status: <b id="statusDisplay">‚Äì</b></div>
          <span class="spacer"></span>
          <button id="btnLogout" class="ghost">Abmelden</button>
        </div>

        <div class="tabbar">
          <button data-tab="tab-map">üó∫ Inselkarte</button>
          <button data-tab="tab-islands">üìä Insel√ºbersicht</button>
          <button data-tab="tab-members" id="tabMembersBtn" class="hidden">üë• Mitglieder</button>
        </div>
      </div>

      <!-- TAB: MAP -->
      <div id="tab-map" class="tabcontent card">
        <div class="legend">
          <span><span class="sw" style="background:#9aa3c7;"></span> kein Spieler</span>
          <span><span class="sw" style="background:var(--magenta);"></span> keine Allianz</span>
          <span>Farben = Allianzen</span>
        </div>
        <canvas id="mapCanvas" width="1800" height="1800"></canvas>
      </div>

      <!-- TAB: ISLANDS -->
      <div id="tab-islands" class="tabcontent card hidden">
        <div class="row" style="justify-content:space-between;margin-bottom:6px;">
          <button id="btnResetFilters" class="ghost">Filter zur√ºcksetzen</button>
          <div>
            <input type="file" id="csvInput" accept=".csv" class="hidden">
            <button id="btnCSV" class="hidden">CSV hochladen (Admin)</button>
            <span id="csvStatus" class="badge"></span>
          </div>
        </div>
        <div class="tablewrap">
          <table id="islandTable">
            <thead><tr id="theadRow"></tr></thead>
            <tbody id="tbodyRows"></tbody>
          </table>
          <div id="filterDropdown" class="col-filter hidden"></div>
        </div>
        <div id="tableStatus" class="badge" style="margin-top:6px;"></div>
      </div>

      <!-- TAB: MEMBERS -->
      <div id="tab-members" class="tabcontent card hidden">
        <h3>Mitgliederverwaltung</h3>
        <div id="membersTable" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

<script type="module">
// ================== Firebase Setup (verk√ºrzt f√ºr √úbersicht) ==================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnrHCuag66za4uKAt_o76QCptpvYqvVNs",
  authDomain: "ik-tool.firebaseapp.com",
  projectId: "ik-tool",
  storageBucket: "ik-tool.firebasestorage.app",
  messagingSenderId: "212260982227",
  appId: "1:212260982227:web:84bfe35c83387c1879f326"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===================== Theme Toggle ===================== */
const themeBtn = document.getElementById("btnTheme");
(function initTheme(){
  const isLight = localStorage.theme==="light";
  document.documentElement.classList.toggle("light", isLight);
  themeBtn.textContent = isLight ? "‚òÄÔ∏è Light" : "üåô Dark";
})();
themeBtn.onclick = ()=>{
  const willLight = !document.documentElement.classList.contains("light");
  document.documentElement.classList.toggle("light", willLight);
  localStorage.theme = willLight ? "light" : "dark";
  themeBtn.textContent = willLight ? "‚òÄÔ∏è Light" : "üåô Dark";
  drawMap();
};

/* ===================== Inselkarte (statisch) ===================== */
const mapCanvas = document.getElementById("mapCanvas");
const ctx = mapCanvas.getContext("2d");

function drawMap(){
  const c = ctx, W = mapCanvas.width, H = mapCanvas.height;
  const style = getComputedStyle(document.documentElement);
  const bg = style.getPropertyValue("--map-bg").trim();
  const gridLight = style.getPropertyValue("--map-grid-light").trim();
  const gridDark = style.getPropertyValue("--map-grid-dark").trim();
  const oceanLine = style.getPropertyValue("--map-ocean").trim();

  c.clearRect(0,0,W,H);
  c.fillStyle = bg;
  c.fillRect(0,0,W,H);

  const TOTAL=120, base=10, cell=base;
  const x0=60, y0=60;

  // Gitter zeichnen
  c.strokeStyle=gridLight; c.lineWidth=0.4;
  for(let i=0;i<=TOTAL;i++){
    const p=x0+i*cell;
    c.beginPath(); c.moveTo(x0,p); c.lineTo(x0+TOTAL*cell,p); c.stroke();
    c.beginPath(); c.moveTo(p,y0); c.lineTo(p,y0+TOTAL*cell); c.stroke();
  }

  // IG-Gitter
  c.strokeStyle=gridDark; c.lineWidth=0.8;
  for(let i=0;i<=TOTAL;i+=4){
    c.beginPath(); c.moveTo(x0,y0+i*cell); c.lineTo(x0+TOTAL*cell,y0+i*cell); c.stroke();
    c.beginPath(); c.moveTo(x0+i*cell,y0); c.lineTo(x0+i*cell,y0+TOTAL*cell); c.stroke();
  }

  // Ozean-Trenner
  c.strokeStyle=oceanLine; c.lineWidth=1.2;
  c.beginPath();
  c.moveTo(x0+60*cell,y0); c.lineTo(x0+60*cell,y0+TOTAL*cell);
  c.moveTo(x0,y0+60*cell); c.lineTo(x0+TOTAL*cell,y0+60*cell);
  c.stroke();

  // IG Nummern
  c.fillStyle=style.getPropertyValue("--text").trim();
  c.font="10px sans-serif";
  for(let i=0;i<225;i++){
    const igc=i%15, igr=Math.floor(i/15);
    const cx=x0+igc*4*cell+2*cell, cy=y0+igr*4*cell+2*cell;
    c.fillText(String(i+1),cx-6,cy+4);
  }
}
drawMap();
</script>
</body>
</html>